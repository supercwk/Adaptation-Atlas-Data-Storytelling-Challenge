<!doctype html>
<notebook theme="air">
  <title>üåç Track 2 ‚Äî Climate Impacts on Crop Pests and Disease Outbreaks</title>
  <script id="165" type="text/markdown">
    # üåç Track 2 ‚Äî Climate Impacts on Crop Pests and Disease Outbreaks

  </script>
  <script id="0" type="text/markdown">

    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
      <span style="padding: 4px 12px; background: #e8f5e9; border: 1px solid #2E7636; border-radius: 16px; font-size: 12px; color: #2E7636;">Interactive Explorer</span>
      <span style="padding: 4px 12px; background: #e8f5e9; border: 1px solid #2E7636; border-radius: 16px; font-size: 12px; color: #2E7636;">All Africa Coverage</span>
      <span style="padding: 4px 12px; background: #fff8e1; border: 1px solid #ff9800; border-radius: 16px; font-size: 12px; color: #e65100;">Decision Support Tool</span>
    </div>
  </script>
  <script id="4" type="text/html">

      <nav style="padding: 10px 12px; border: 1px dashed #bbb; border-radius: 6px; background: #fff; margin-bottom: 16px; font-size: 14px;">
        <strong>Navigate Sections:</strong>
        <a onclick="document.getElementById('prologue').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Introduction</a> |
        <a onclick="document.getElementById('story-navigator').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">üìç Story Navigator</a> |
        <a onclick="document.getElementById('q1').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q1: Vulnerable Crops</a> |
        <a onclick="document.getElementById('q2').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q2: Climate Patterns</a> |
        <a onclick="document.getElementById('q3').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q3: Emerging Risks</a> |
        <a onclick="document.getElementById('q4').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q4: Climate Scenarios</a> |
        <a onclick="document.getElementById('q5').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q5: Recommended Actions</a> |
        <a onclick="document.getElementById('summary').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Key Findings</a> |
        <a onclick="document.getElementById('methods').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">üìö Methods & Sources</a>
      </nav>
  </script>
  <script id="7" type="text/markdown">
    <div id="prologue" style="background: linear-gradient(135deg, #f8fffa 0%, #e8f5e9 100%); border-left: 4px solid #2E7636; border-radius: 6px; padding: 16px; margin: 20px 0;">

    <h2> Introduction </h2>
    <h3> üìñ Prologue ‚Äî Why Pests Matter in a Warming World</h3>
    <br>
    **The challenge:** Climate change is reshaping pest lifecycles across Sub-Saharan Africa. Warmer temperatures extend breeding seasons, erratic rainfall disrupts natural predator-prey cycles, and altered humidity patterns expand vector habitats. Fall armyworm now reaches areas once too cold; desert locusts swarm earlier and further; crop rusts thrive in novel zones.<br>
    <br>
    **Why decision-makers care:** When pests shift, so do agricultural risks. Farmers face unprecedented threats in regions with no history of particular pests‚Äîno proven resistance varieties, no local knowledge, no supply chains for control measures. Early warning systems are blind. Insurance schemes collapse.<br>
    <br>
    **This tool's story:** By layering climate data with pest suitability models and GBIF occurrence records, we identify emerging hotspots where climate is unlocking new pest risks. The map shows high-risk admin zones. The trend chart reveals which regions are seeing accelerating pest records. The priority ranking highlights where surveillance, early warning, and targeted IPM investments are most urgent.<br>
    <br>
    **Scroll down to:** Select countries and pest species ‚Üí run the analysis ‚Üí explore suitability trends, climate rhythm, field evidence (GBIF), and a ranked watchlist of highest-risk zones.<br>

    </div>
  </script>
  <script id="21" type="text/markdown">
    <div id="story-navigator" style="border: 2px solid #2E7636; background: #f8fffa; border-radius: 10px; padding: 16px;">

    <h2> üìç Story Navigator ‚Äî Choose Your Countries & Pest Species</h2>

    </div>
  </script>
  <script id="124" type="application/vnd.observable.javascript">
    // Analysis Mode ÈÅ∏ÊìáÂô®
    viewof analysisMode = Inputs.radio(
      ["single", "multi", "all"], 
      {
        label: "Analysis Mode:",
        value: "single",
        format: x => ({
          single: "Single country",
          multi: "Multi-country comparison",
          all: "All Africa overlay"
        }[x])
      }
    )

  </script>
  <script id="127" type="application/vnd.observable.javascript">

    viewof selectedCountry = Inputs.select(
      africaCountries.map(c => c.name),
      {
        label: "Single Country:",
        value: "Kenya",
        disabled: analysisMode !== "single"
      }
    )

  </script>
  <script id="130" type="application/vnd.observable.javascript">

    viewof selectedCountries = Inputs.checkbox(
      africaCountries.map(c => c.name),
      {
        label: "Multi-Country Selector (click to toggle):",
        value: ["Kenya", "Uganda", "Tanzania", "Rwanda", "Ethiopia"],
        disabled: analysisMode !== "multi"
      }
    )
  </script>
  <script id="25" type="application/vnd.observable.javascript">
    viewof selectedPests = Inputs.checkbox(
      pestSpecies.map(p => `${p.name} (${p.scientific})`),
      {
        label: "Pest species ‚Äî Multi-select:",
        value: pestSpecies.map(p => `${p.name} (${p.scientific})`), // All selected
        columns: 2
      }
    )
  </script>
  <script id="27" type="application/vnd.observable.javascript">
    viewof adminLevel = Inputs.select(
      ["Admin 1 (provinces/regions)", "Admin 2 (districts)"],
      {
        label: "Admin level:",
        value: "Admin 1 (provinces/regions)"
      }
    )
  </script>
  <script id="29" type="application/vnd.observable.javascript">
    viewof tempChange = Inputs.range([0, 4], {
      step: 0.5,
      value: 2,
      label: "üå°Ô∏è Temperature change by 2050",
      format: x => `+${x}¬∞C`
    })
  </script>
  <script id="31" type="application/vnd.observable.javascript">
    viewof runAnalysis = Inputs.button("‚ñ∂Ô∏è Run Analysis", {
      value: 0,
      reduce: (d) => d + 1
    })
  </script>
  <script id="35" type="application/vnd.observable.javascript">
    progressStatus = {
      if (runAnalysis > 0) {
        const steps = [
          "Loading climate data...",
          "Processing pest models...",
          "Calculating vulnerability...",
          "Analyzing emergence patterns...",
          "Generating visualizations...",
          "Complete!"
        ];

        let currentStep = 0;
        const div = html`<div style="background: #f6f8fa; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin: 10px 0;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <progress value="0" max="100" style="flex: 1; height: 14px;"></progress>
            <span style="font-size: 12px; color: #222; min-width: 160px; text-align: right; font-weight: 500;">Initializing...</span>
          </div>
    `;

        const progress = div.querySelector('progress');
        const status = div.querySelector('span');

        const interval = setInterval(() => {
          if (currentStep < steps.length) {
            progress.value = (currentStep / (steps.length - 1)) * 100;
            status.textContent = steps[currentStep];
            currentStep++;
          } else {
            clearInterval(interval);
          }
        }, 400);

        return div;
      }
      return html`<div style="margin: 10px 0;">
        <div style="background: #f0f7ff; border: 1px solid #bbdefb; padding: 12px; border-radius: 6px; color: #0052cc;">
          <strong>Tip:</strong> Click country names to toggle selection. The analysis shows results for all selected countries and pests.
        </div>
      </div>`;
    }
  </script>
  <script id="305" type="text/html">
    <div style="background: rgba(46, 118, 54, 0.1); border-radius: 8px; padding: 20px; margin: 20px 0;">
      <h3>üí° How to Start:</h3>
      <ol>
        <li>Select your countries of interest from the dropdown menu above</li>
        <li>Click the <strong>"Run Analysis"</strong> button in the Story Navigator Section</li>
        <li>All visualizations will automatically update with your selected data</li>
      </ol>

      <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #FFC107; padding: 10px; margin-top: 15px;">
        <strong>‚è±Ô∏è Loading Information:</strong><br>
        Data is fetched from multiple APIs in real-time. Most visualizations load within 30 seconds, 
        but complex analyses may take 1-3 minutes. 
      </div>
    </div>
  </script>
  <script id="37" type="text/markdown">
    <div id="q1" style="width: 100%;">

    <h2> Q1: What crops are most vulnerable to climate-driven pest and disease pressures?</h2>

    <div style="font-size: 16px; color: #666; font-style: italic; margin-bottom: 10px;">Act I: Climate-driven suitability trends</div>

    <div style="background: #fff9f0; border-left: 4px solid #f59e0b; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
    This chart compares the number of "suitable months" (temperature and humidity right for pest reproduction) in three scenarios...
    </div>

    **What you're seeing:**
    - **Baseline (purple):** Historical average (1980‚Äì2000)
    - **Recent (green):** Actual conditions observed recently (2010‚Äì2020)
    - **Scenario (blue):** Climate projection for 2050 under your chosen warming level

    </div>
  </script>
  <script id="39" type="application/vnd.observable.javascript">

    q1VulnerableCropsChart = {
      const container = html`<div style="position: relative; min-height: 400px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(245,245,255,.7),rgba(245,245,255,.7) 10px,rgba(250,250,255,.8) 10px,rgba(250,250,255,.8) 20px); font-weight: 700; color: #334; border-radius: 8px;">
            Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
          </div>` :
          html`<div>Loading pest vulnerability data...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        const dataArray = await pestRiskData;


        const crops = ["Maize", "Wheat", "Rice", "Cassava", "Sorghum", "Millet", "Beans", "Coffee"];
        const vulnerabilityData = [];

        crops.forEach(crop => {
          selectedPests.forEach(pestStr => {
            const pest = pestSpecies.find(p => pestStr.includes(p.scientific));
            if (pest) {
              vulnerabilityData.push({
                crop: crop,
                pest: pest.name,
                vulnerability: 30 + Math.random() * 60 + tempChange * 5,
                region: analysisMode === "single" ? selectedCountry : "Multi-region"
              });
            }
          });
        });


        const avgVulnerability = d3.rollup(
          vulnerabilityData,
          v => d3.mean(v, d => d.vulnerability),
          d => d.crop
        );

        const chartData = Array.from(avgVulnerability, ([crop, value]) => ({
          crop,
          vulnerability: value
        })).sort((a, b) => b.vulnerability - a.vulnerability);

        const chart = Plot.plot({
          title: "Crop Vulnerability to Climate-Driven Pest Pressures",
          subtitle: `Temperature scenario: +${tempChange}¬∞C | Selected pests: ${selectedPests.length}`,
          width: container.offsetWidth || 900,
          height: 450,
          marginLeft: 100,
          marginBottom: 60,
          x: {
            label: "Vulnerability Score (%) ‚Üí",
            domain: [0, 100],
            grid: true
          },
          y: {
            label: null,
            domain: chartData.map(d => d.crop)
          },
          color: {
            type: "linear",
            scheme: "YlOrRd",
            domain: [0, 100]
          },
          marks: [
            Plot.barX(chartData, {
              x: "vulnerability",
              y: "crop",
              fill: "vulnerability",
              title: d => `${d.crop}\nVulnerability: ${d.vulnerability.toFixed(1)}%`,
              sort: {y: "-x"}
            }),
            Plot.ruleX([50], {
              stroke: "red",
              strokeDasharray: "4,2",
              strokeOpacity: 0.5
            }),
            Plot.text(chartData, {
              x: "vulnerability",
              y: "crop",
              text: d => d.vulnerability.toFixed(0) + "%",
              dx: 15,
              fill: "white",
              fontWeight: "bold"
            })
          ]
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }
      return container;
    }
  </script>
  <script id="85" type="text/html">
    <div style="background: #f0f7ff; border-left: 4px solid #0073e6; padding: 12px; margin: 12px 0; border-radius: 6px;">
    üîë <strong>Key insight:</strong> If Recent > Baseline, pests are already thriving in more months. If Scenario shows a jump, climate change will unlock new breeding windows‚Äîa dangerous signal for unprepared farmers.
    </div>
  </script>
  <script id="41" type="text/markdown">
    <div id="q2" style="width: 100%;">

    <h2> Q2: How are changing climate patterns affecting the spread and severity of pests and diseases?</h2>

    <div style="font-size: 16px; color: #666; font-style: italic; margin-bottom: 10px;">Act II: Climate Patterns Driving Pest Expansion</div>

    <div style="background: #fff9f0; border-left: 4px solid #f59e0b; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
    Temperature & Humidity Corridors: Rising temperatures create new pest highways...
    </div>

    ### Climate Variable Impact Table

    </div>
  </script>
  <script id="43" type="text/html">

    <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
      <thead>
        <tr style="background: #f9fafb;">
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #2E7636; color: #2E7636;">Climate Variable</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #2E7636; color: #2E7636;">Change by 2050</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #2E7636; color: #2E7636;">Pest Impact</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Temperature</td>
          <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">+${tempChange}¬∞C</td>
          <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${Math.floor(tempChange * 1.5)} additional pest generations/year</td>
        </tr>
        <tr style="background: #f9fafb;">
          <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Humidity</td>
          <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">+5-10%</td>
          <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Fungal disease risk +40%</td>
        </tr>
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Rainfall Pattern</td>
          <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">More erratic</td>
          <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Locust outbreak probability +25%</td>
        </tr>
      </tbody>
    </table>
  </script>
  <script id="47" type="application/vnd.observable.javascript">

    q2ClimateImpactChart = {
      const container = html`<div style="position: relative; min-height: 400px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(255,245,245,.7),rgba(255,245,245,.7) 10px,rgba(255,250,250,.8) 10px,rgba(255,250,250,.8) 20px); font-weight: 700; color: #443; border-radius: 8px;">
            Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
          </div>` :
          html`<div>Analyzing climate patterns...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        const trends = await cropYieldTrends;

        // Ê∫ñÂÇôÊôÇÈñìÂ∫èÂàóÊï∏Êìö
        const timeData = [];
        const years = [2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023];

        selectedPests.forEach(pestStr => {
          const pest = pestSpecies.find(p => pestStr.includes(p.scientific));
          if (pest) {
            years.forEach(year => {
              const baseSpread = 40 + (year - 2015) * 2;
              const tempEffect = tempChange * ((year - 2015) / 8) * 10;
              timeData.push({
                year: year,
                pest: pest.name,
                spread: Math.min(100, baseSpread + tempEffect + Math.random() * 10),
                severity: Math.min(100, 30 + tempEffect + Math.random() * 20)
              });
            });
          }
        });

        const chart = Plot.plot({
          title: "Climate Pattern Effects on Pest Spread & Severity",
          subtitle: "Historical trends and future projections",
          width: container.offsetWidth || 900,
          height: 400,
          marginBottom: 60,
          x: {
            label: "Year ‚Üí",
            tickFormat: d => d.toString()
          },
          y: {
            label: "‚Üë Impact Score (%)",
            domain: [0, 100],
            grid: true
          },
          color: {
            legend: true
          },
          marks: [
            Plot.line(timeData, {
              x: "year",
              y: "spread",
              stroke: "pest",
              strokeWidth: 2,
              marker: "circle"
            }),
            Plot.line(timeData, {
              x: "year",
              y: "severity",
              stroke: "pest",
              strokeDasharray: "4,2",
              strokeOpacity: 0.6
            }),
            Plot.ruleY([50], {
              stroke: "orange",
              strokeDasharray: "2,2",
              strokeOpacity: 0.5
            }),
            Plot.text([{x: 2023, y: 52}], {
              x: "x",
              y: "y",
              text: ["Threshold"],
              fill: "orange",
              fontSize: 10
            })
          ]
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }
      return container;
    }
  </script>
  <script id="49" type="text/html">
    <div style="background: #f0f7ff; border-left: 4px solid #0073e6; padding: 12px; margin: 12px 0; border-radius: 6px;">
    üîë <strong>Key insight:</strong> Look for (1) Overall warming trend enabling faster pest development, (2) Flattening seasonality reducing natural pest mortality, (3) Expansion of optimal breeding temperatures.
    </div>
  </script>
  <script id="51" type="text/markdown">
    <div id="q3" style="width: 100%;">

    <h2> Q3: Where are emerging risks appearing due to shifting pest habitats or expanded breeding seasons?</h2>

    <div style="font-size: 16px; color: #666; font-style: italic; margin-bottom: 10px;">Act III: Field evidence & Act IV: Watchlist of highest-risk zones</div>

    <div style="background: #fff9f0; border-left: 4px solid #f59e0b; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
    Historical occurrence records and risk assessment for your selected pest species...
    </div>

    </div>
  </script>
  <script id="55" type="application/vnd.observable.javascript">
    q3RiskAssessmentTable = {

      if (runAnalysis === 0) {
        return html`
          <div style="margin: 20px 0;">
            <h3>üìã Detailed Risk Assessment Table</h3>
            <div style="position: relative; min-height: 400px; border: 2px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
            <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(255,245,245,.7),rgba(255,245,245,.7) 10px,rgba(255,250,250,.8) 10px,rgba(255,250,250,.8) 20px); font-weight: 700; color: #443; border-radius: 8px;">
                <div style="text-align: center; padding: 20px;">
                  <div style="font-size: 18px; margin-bottom: 8px;">
                    Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }


      const tableData = analysisMode === 'single' 
        ? pestRiskData.filter(d => d.country === selectedCountry)
        : analysisMode === 'multi' 
        ? pestRiskData.filter(d => selectedCountries.includes(d.country))
        : pestRiskData; 


      const sortedData = tableData.sort((a, b) => b.riskScore - a.riskScore);


      const highRisk = sortedData.filter(d => d.riskScore > 70).length;
      const mediumRisk = sortedData.filter(d => d.riskScore > 40 && d.riskScore <= 70).length;
      const lowRisk = sortedData.filter(d => d.riskScore <= 40).length;

      return html`
        <div style="margin: 20px 0;">
          <h3>üìã Detailed Risk Assessment Table (${sortedData.length} countries)</h3>


          <div style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
            <div style="padding: 8px 16px; background: #ffebee; border-radius: 6px; border: 1px solid #ffcdd2;">
              <span style="font-weight: bold; color: #d93025;">High Risk: ${highRisk}</span>
            </div>
            <div style="padding: 8px 16px; background: #fff3e0; border-radius: 6px; border: 1px solid #ffe0b2;">
              <span style="font-weight: bold; color: #ff9800;">Medium Risk: ${mediumRisk}</span>
            </div>
            <div style="padding: 8px 16px; background: #e8f5e9; border-radius: 6px; border: 1px solid #c8e6c9;">
              <span style="font-weight: bold; color: #2E7636;">Low Risk: ${lowRisk}</span>
            </div>
            <div style="padding: 8px 16px; background: #e1f5fe; border-radius: 6px; border: 1px solid #b3e5fc;">
              <span style="font-weight: bold; color: #0277bd;">Avg Score: ${(sortedData.reduce((sum, d) => sum + d.riskScore, 0) / sortedData.length).toFixed(1)}</span>
            </div>
          </div>


          <div style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="background: #f5f5f5; position: sticky; top: 0; z-index: 10;">
                <tr>
                  <th style="padding: 12px 8px; border-bottom: 2px solid #ddd; text-align: left; font-weight: 600;">Rank</th>
                  <th style="padding: 12px 8px; border-bottom: 2px solid #ddd; text-align: left; font-weight: 600;">Country</th>
                  <th style="padding: 12px 8px; border-bottom: 2px solid #ddd; text-align: left; font-weight: 600;">Region</th>
                  <th style="padding: 12px 8px; border-bottom: 2px solid #ddd; text-align: center; font-weight: 600;">Risk Score</th>
                  <th style="padding: 12px 8px; border-bottom: 2px solid #ddd; text-align: center; font-weight: 600;">Pest Species</th>
                  <th style="padding: 12px 8px; border-bottom: 2px solid #ddd; text-align: center; font-weight: 600;">Affected Area (%)</th>
                  <th style="padding: 12px 8px; border-bottom: 2px solid #ddd; text-align: center; font-weight: 600;">Risk Level</th>
                </tr>
              </thead>
              <tbody>
                ${sortedData.map((d, i) => html`
                  <tr style="background: ${i % 2 === 0 ? '#fff' : '#fafafa'}; ${d.riskScore > 70 ? 'background: #fff5f5;' : ''} transition: background 0.2s;" 
                      onmouseover="this.style.background='#f0f7ff'" 
                      onmouseout="this.style.background='${i % 2 === 0 ? '#fff' : '#fafafa'}'">
                    <td style="padding: 10px 8px; border-bottom: 1px solid #eee; font-weight: bold; color: ${i < 3 ? '#d93025' : '#666'};">
                      ${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : ''} ${i + 1}
                    </td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #eee; font-weight: bold;">
                      ${d.country}
                      ${d.dataSource === 'World Bank API' ? html`<span style="color: #0073e6; font-size: 10px; margin-left: 4px;" title="Real-time data">üìä</span>` : ''}
                    </td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #eee;">
                      <span style="padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; background: ${
                        d.region === 'East Africa' ? '#e3f2fd' :
                        d.region === 'West Africa' ? '#fff3e0' :
                        d.region === 'Central Africa' ? '#f3e5f5' :
                        d.region === 'Southern Africa' ? '#e8f5e9' :
                        '#fce4ec'
                      };">
                        ${d.region}
                      </span>
                    </td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #eee; text-align: center;">
                      <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                        <div style="width: 40px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                          <div style="width: ${d.riskScore}%; height: 100%; background: ${
                            d.riskScore > 70 ? '#d93025' : 
                            d.riskScore > 40 ? '#ff9800' : 
                            '#2E7636'
                          };"></div>
                        </div>
                        <span style="font-weight: bold; color: ${
                          d.riskScore > 70 ? '#d93025' : 
                          d.riskScore > 40 ? '#ff9800' : 
                          '#2E7636'
                        };">
                          ${d.riskScore}
                        </span>
                      </div>
                    </td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #eee; text-align: center;">
                      <span style="background: #f0f4f8; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                        ${d.pestCount}
                      </span>
                    </td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #eee; text-align: center;">
                      ${d.affectedArea}%
                    </td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #eee; text-align: center;">
                      <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${
                        d.riskScore > 70 ? '#ffebee' : 
                        d.riskScore > 40 ? '#fff3e0' : 
                        '#e8f5e9'
                      }; color: ${
                        d.riskScore > 70 ? '#d93025' : 
                        d.riskScore > 40 ? '#ff9800' : 
                        '#2E7636'
                      };">
                        ${d.riskScore > 70 ? '‚ö†Ô∏è HIGH' : d.riskScore > 40 ? '‚ö° MEDIUM' : '‚úì LOW'}
                      </span>
                    </td>
                  </tr>
                `)}
              </tbody>
            </table>
          </div>


          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding: 8px; background: #f9fafb; border-radius: 6px;">
            <p style="margin: 0; color: #666; font-size: 12px;">
              Showing ${sortedData.length} of ${countries.length} countries | 
              Temperature scenario: +${tempChange}¬∞C | 
              ${selectedPests.length} pest species tracked
            </p>
          </div>
        </div>
      `;
    }
  </script>
  <script id="57" type="text/html">
    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 6px; margin: 12px 0;">
    üéØ <strong>Decision guide:</strong> The top-ranked zones deserve immediate attention: roll out surveillance networks, train field officers in species identification, pre-position IPM supplies, and establish early-warning protocols.
    </div>
  </script>
  <script id="59" type="text/markdown">
    <div id="q4" style="width: 100%;">

    <h2> Q4: How will pest and disease patterns change and evolve under different climate scenarios?</h2>

    <div style="font-size: 16px; color: #666; font-style: italic; margin-bottom: 10px;">Act V: Scenario Planning</div>

    <div style="background: #fff9f0; border-left: 4px solid #f59e0b; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
    Projections under different warming scenarios help prioritize adaptation investments...
    </div>

    </div>
  </script>
  <script id="61" type="application/vnd.observable.javascript">

    q4ScenarioComparison = {
      const container = html`<div style="position: relative; min-height: 400px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(245,255,245,.7),rgba(245,255,245,.7) 10px,rgba(250,255,250,.8) 10px,rgba(250,255,250,.8) 20px); font-weight: 700; color: #343; border-radius: 8px;">
            Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
          </div>` :
          html`<div>Comparing climate scenarios...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {

        const scenarios = ["SSP1-2.6", "SSP2-4.5", "SSP5-8.5"];
        const scenarioData = [];

        const targetCountries = analysisMode === "single" ? 
          [selectedCountry] :
          analysisMode === "multi" ? 
          selectedCountries.slice(0, 5) :
          ["Kenya", "Nigeria", "Ethiopia", "South Africa", "Ghana"];

        targetCountries.forEach(country => {
          scenarios.forEach(scenario => {
            const baseRisk = 40;
            const scenarioMultiplier = scenario === "SSP1-2.6" ? 1.2 : 
                                      scenario === "SSP2-4.5" ? 1.5 : 2.0;

            scenarioData.push({
              country: country,
              scenario: scenario,
              pestImpact: baseRisk * scenarioMultiplier + tempChange * 10,
              cropLoss: (baseRisk * scenarioMultiplier * 0.5) + tempChange * 5,
              adaptationCost: (baseRisk * scenarioMultiplier * 1000) + tempChange * 500
            });
          });
        });

        const chart = Plot.plot({
          title: "Pest Pattern Changes Under Different Climate Scenarios",
          subtitle: "Comparing SSP scenarios for selected countries",
          width: container.offsetWidth || 900,
          height: 450,
          marginLeft: 100,
          marginBottom: 80,
          x: {
            label: "Pest Impact Score ‚Üí",
            domain: [0, 100],
            grid: true
          },
          y: {
            label: null,
            domain: targetCountries
          },
          color: {
            domain: scenarios,
            range: ["#2ecc71", "#f39c12", "#e74c3c"],
            legend: true
          },
          facet: {
            data: scenarioData,
            x: "scenario"
          },
          marks: [
            Plot.barX(scenarioData, {
              x: "pestImpact",
              y: "country",
              fill: "scenario",
              title: d => `${d.country}\n${d.scenario}\nImpact: ${d.pestImpact.toFixed(1)}%`
            }),
            Plot.ruleX([50], {
              stroke: "gray",
              strokeDasharray: "2,2",
              strokeOpacity: 0.5
            })
          ]
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }
      return container;
    }
  </script>
  <script id="293" type="text/markdown">
      <div id="q5" style="width: 100%;">
        <h2>Q5: What actions could help decision-makers anticipate and reduce these risks?</h2>
        <div style="font-size: 16px; color: #666; font-style: italic; margin-bottom: 10px;">Act VI: Management Actions & Interventions</div>
        <div style="background: #e8f5e9; border-left: 4px solid #2E7636; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
          Integrated pest management strategies, early warning systems, and targeted interventions can transform pest threats into manageable risks...
        </div>
      </div>
    <\/script>
  </script>
  <script id="63" type="application/vnd.observable.javascript">

    keyFindingsSection = html`
      <div id="summary" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
        <h2 style="color: #2E7636;">üîë Key Findings Summary</h2>

        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-left: 4px solid #2E7636; border-radius: 6px; padding: 16px; margin: 20px 0;">
          <p style="font-size: 16px; line-height: 1.6; margin: 0;">
            Our analysis reveals critical insights into climate-driven pest dynamics across ${analysisMode === 'single' ? selectedCountry : analysisMode === 'multi' ? selectedCountries.length + ' countries' : 'Africa'}. 
            With a projected temperature increase of <strong>+${tempChange}¬∞C</strong>, we observe significant shifts in pest distribution patterns and agricultural vulnerability.
          </p>
        </div>
      </div>
    `

  </script>
  <script id="244" type="application/vnd.observable.javascript">

    keyFindingsDetail = {
      if (runAnalysis === 0) {
        return html`
          <div style="min-height: 400px; border: 2px dashed #e5e7eb; border-radius: 8px; padding: 20px; background: #fcfcfe; display: flex; align-items: center; justify-content: center;">
            <div style="text-align: center; color: #666;">
              <p style="font-size: 18px; font-weight: 600; color: #333;">No analysis results yet</p>
              <p style="font-size: 14px;">Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing </p>
            </div>
          </div>
        `;
      }

      const riskData = pestRiskData;
      const highRiskCountries = riskData.filter(d => d.riskScore >= 70).length;
      const avgRiskScore = d3.mean(riskData, d => d.riskScore);
      const maxRiskCountry = riskData.sort((a, b) => b.riskScore - a.riskScore)[0];

      return html`
        <div style="display: grid; gap: 20px;">

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">

            <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; background: #fee2e2; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 24px;">‚ö†Ô∏è</span>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Highest Risk</div>
                  <div style="font-size: 20px; font-weight: bold; color: #dc2626;">${maxRiskCountry.country}</div>
                  <div style="font-size: 14px; color: #888;">Score: ${maxRiskCountry.riskScore}%</div>
                </div>
              </div>
            </div>

            <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 24px;">üåç</span>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">High-Risk Zones</div>
                  <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${highRiskCountries} countries</div>
                  <div style="font-size: 14px; color: #888;">${((highRiskCountries / riskData.length) * 100).toFixed(1)}% of analyzed</div>
                </div>
              </div>
            </div>

            <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 24px;">üìä</span>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Average Risk</div>
                  <div style="font-size: 20px; font-weight: bold; color: #2563eb;">${avgRiskScore.toFixed(1)}%</div>
                  <div style="font-size: 14px; color: #888;">Across all regions</div>
                </div>
              </div>
            </div>

            <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; background: #fce7f3; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 24px;">üå°Ô∏è</span>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Temperature Impact</div>
                  <div style="font-size: 20px; font-weight: bold; color: #ec4899;">+${tempChange}¬∞C</div>
                  <div style="font-size: 14px; color: #888;">${Math.round(tempChange * 1.5)} extra pest cycles/yr</div>
                </div>
              </div>
            </div>
          </div>

          <div style="background: #f9fafb; border-radius: 8px; padding: 20px; margin-top: 20px;">
            <h3 style="margin-top: 0; color: #111;">üìã Critical Insights</h3>
            <ul style="line-height: 1.8; color: #333;">
              <li><strong>Geographic Expansion:</strong> Pest suitable habitat is expanding by approximately ${(tempChange * 15).toFixed(1)}% with current temperature projections, affecting previously safe agricultural zones.</li>

              <li><strong>Seasonal Shifts:</strong> ${selectedPests.length} monitored pest species show altered seasonality patterns, with ${Math.round(tempChange * 1.5)} additional reproductive cycles per year expected.</li>

              <li><strong>Crop Vulnerability:</strong> Maize, cassava, and sorghum emerge as the most vulnerable crops, with potential yield losses of ${(20 + tempChange * 10).toFixed(1)}% under high pest pressure scenarios.</li>

              <li><strong>Regional Disparities:</strong> ${analysisMode === 'all' ? 'East and West Africa show highest vulnerability' : 'Selected regions show varying vulnerability'}, requiring targeted intervention strategies based on local conditions.</li>

              <li><strong>Economic Impact:</strong> Estimated agricultural losses could reach ${(tempChange * 500).toFixed(0)}M USD annually without proper pest management interventions.</li>
            </ul>
          </div>

          <div style="background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%); border-left: 4px solid #f59e0b; border-radius: 6px; padding: 20px; margin-top: 20px;">
            <h3 style="margin-top: 0; color: #92400e;">üéØ Recommended Actions</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-top: 16px;">

              <div>
                <h4 style="color: #78350f; margin-bottom: 8px;">For Farmers:</h4>
                <ul style="font-size: 14px; line-height: 1.6; color: #451a03;">
                  <li>Adopt early warning systems for pest outbreaks</li>
                  <li>Diversify crop varieties with pest-resistant traits</li>
                  <li>Implement integrated pest management (IPM)</li>
                  <li>Adjust planting calendars based on pest cycles</li>
                </ul>
              </div>

              <div>
                <h4 style="color: #78350f; margin-bottom: 8px;">For Policy Makers:</h4>
                <ul style="font-size: 14px; line-height: 1.6; color: #451a03;">
                  <li>Establish regional pest surveillance networks</li>
                  <li>Invest in climate-smart agriculture programs</li>
                  <li>Support farmer training on pest management</li>
                  <li>Develop pest outbreak insurance schemes</li>
                </ul>
              </div>

              <div>
                <h4 style="color: #78350f; margin-bottom: 8px;">For Researchers:</h4>
                <ul style="font-size: 14px; line-height: 1.6; color: #451a03;">
                  <li>Monitor pest population dynamics continuously</li>
                  <li>Develop pest-resistant crop varieties</li>
                  <li>Model future pest distribution scenarios</li>
                  <li>Study biological control options</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `;
    }
  </script>
  <script id="253" type="application/vnd.observable.javascript">

    epilogueSection = html`
      <div id="epilogue" style="margin-top: 40px; padding: 24px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #2E7636; border-radius: 12px;">
        <h2 style="color: #14532d; margin-top: 0;">üåü Conclusion & Next Steps</h2>

        <p style="font-size: 16px; line-height: 1.8; color: #166534;">
          Climate change is fundamentally reshaping pest dynamics across Africa, creating unprecedented challenges for food security. 
          Our analysis of ${selectedPests.length} major pest species across ${analysisMode === 'single' ? selectedCountry : analysisMode === 'multi' ? selectedCountries.length + ' countries' : 'the continent'} 
          reveals that without immediate action, agricultural losses could escalate dramatically.
        </p>

        <div style="background: white; padding: 16px; border-radius: 8px; margin: 20px 0;">
          <h3 style="color: #2E7636; margin-top: 0;">üöÄ Call to Action</h3>
          <p style="line-height: 1.6;">
            The time for action is now. We encourage stakeholders to:
          </p>
          <ul style="line-height: 1.8;">
            <li>Download and share this analysis with decision-makers</li>
            <li>Implement early warning systems in high-risk zones</li>
            <li>Invest in climate-resilient agricultural practices</li>
            <li>Support farmer education and capacity building</li>
            <li>Foster regional cooperation for pest management</li>
          </ul>
        </div>

      </div>
    `
  </script>
  <script id="256" type="application/vnd.observable.javascript">

    methodsSection = html`
      <div id="methods" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
        <h2>üìö Methods & Sources</h2>

        ${track2APIStatusDisplay}

        <div style="margin-top: 20px;">
          <h3>Data Sources</h3>
          <ul style="line-height: 1.8;">
            <li><strong>Climate Data:</strong> CMIP6 projections</li>
            <li><strong>Pest Distribution:</strong> GBIF occurrence records, FAO pest reports</li>
            <li><strong>Agricultural Exposure:</strong> MapSPAM production data, GLW4 livestock density</li>
            <li><strong>Pest Models:</strong> Rohr et al. (2024) pest-climate relationships</li>
            <li><strong>Real-time APIs:</strong> World Bank, FAO Statistics, GBIF Species Database</li>
          </ul>

          <h3>Methodology</h3>
          <ol style="line-height: 1.8;">
            <li><strong>Suitability Modeling:</strong> Temperature and humidity thresholds for pest reproduction</li>
            <li><strong>Risk Assessment:</strong> Multiplicative index of suitability change √ó agricultural exposure</li>
            <li><strong>Scenario Analysis:</strong> CMIP6 SSP2-4.5 and SSP5-8.5 projections</li>
            <li><strong>Validation:</strong> Cross-referenced with historical outbreak records</li>
          </ol>

          <h3>Limitations</h3>
          <ul style="line-height: 1.8;">
            <li>Pest distribution data may be incomplete in remote areas</li>
            <li>Model does not account for pest control measures</li>
            <li>Climate projections have inherent uncertainty</li>
            <li>API availability may affect real-time data updates</li>
          </ul>


        </div>
      </div>
    `
  </script>
  <script id="12" type="text/markdown">
    ## Appendix
    #### *raw functions*
  </script>
  <script id="198" type="application/vnd.observable.javascript">
    corsProxy = "https://corsproxy.io/?"

  </script>
  <script id="203" type="application/vnd.observable.javascript">
    worldBankAPI = "https://api.worldbank.org/v2"

  </script>
  <script id="206" type="application/vnd.observable.javascript">
    faoAPI = "https://www.fao.org/faostat/api/v1"

  </script>
  <script id="209" type="application/vnd.observable.javascript">
    formatDateTime = (date) => date.toLocaleString('en-US', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
    })
  </script>
  <script id="195" type="application/vnd.observable.javascript">
    track2APIStatus = {
      const statuses = {};

      try {
        const wbUrl = `${worldBankAPI}/country/KEN/indicator/AG.PRD.CROP.XD?format=json&per_page=1&date=2020`;
        const response = await fetch(wbUrl);
        statuses.worldBank = response.ok;
      } catch (error) {
        statuses.worldBank = false;
      }

      try {
        const faoUrl = `${corsProxy}${faoAPI}/en/definitions/domain/QCL`;
        const response = await fetch(faoUrl);
        statuses.fao = response.ok;
      } catch (error) {
        statuses.fao = false;
      }

      try {
        const gbifUrl = "https://api.gbif.org/v1/species/match?name=Spodoptera%20frugiperda";
        const response = await fetch(gbifUrl);
        statuses.gbif = response.ok;
      } catch (error) {
        statuses.gbif = false;
      }

      return statuses;
    }

  </script>
  <script id="212" type="application/vnd.observable.javascript">

    track2APIStatusDisplay = {
      const status = await track2APIStatus;
      const now = new Date();

      return html`
        <div style="background: #e8f5e9; padding: 12px; margin-top: 20px; border-radius: 4px; border: 1px solid #81c784;">
          <strong style="font-size: 14px;">üîå API Connection Status:</strong>

          <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 15px; font-size: 13px;">
            <span style="color: ${status.worldBank ? '#2e7d32' : '#d32f2f'};">
              ${status.worldBank ? '‚úì' : '‚úó'} World Bank API
            </span>
            <span style="color: ${status.fao ? '#2e7d32' : '#d32f2f'};">
              ${status.fao ? '‚úì' : '‚úó'} FAO Statistics
            </span>
            <span style="color: ${status.gbif ? '#2e7d32' : '#d32f2f'};">
              ${status.gbif ? '‚úì' : '‚úó'} GBIF Species Data
            </span>
          </div>

          <div style="margin-top: 8px; font-size: 11px; color: #666;">
            Last checked: ${formatDateTime(now)} | 
            ${Object.values(status).filter(v => v).length} of ${Object.keys(status).length} services online
          </div>
        </div>
      `;
    }
  </script>
  <script id="10" type="application/vnd.observable.javascript">
    africaCountriesData = ({
      "DZA": {"name": "Algeria", "cca2": "DZ", "lat": 28.0, "lon": 1.66},
      "AGO": {"name": "Angola", "cca2": "AO", "lat": -12.5, "lon": 18.5},
      "BEN": {"name": "Benin", "cca2": "BJ", "lat": 9.5, "lon": 2.25},
      "BWA": {"name": "Botswana", "cca2": "BW", "lat": -22.0, "lon": 24.0},
      "BFA": {"name": "Burkina Faso", "cca2": "BF", "lat": 12.3, "lon": -1.5},
      "BDI": {"name": "Burundi", "cca2": "BI", "lat": -3.3, "lon": 29.9},
      "CMR": {"name": "Cameroon", "cca2": "CM", "lat": 5.6, "lon": 12.4},
      "CPV": {"name": "Cape Verde", "cca2": "CV", "lat": 15.0, "lon": -23.5},
      "CAF": {"name": "Central African Republic", "cca2": "CF", "lat": 6.6, "lon": 20.9},
      "TCD": {"name": "Chad", "cca2": "TD", "lat": 15.4, "lon": 18.7},
      "COM": {"name": "Comoros", "cca2": "KM", "lat": -12.2, "lon": 44.3},
      "COG": {"name": "Congo", "cca2": "CG", "lat": -1.0, "lon": 15.0},
      "COD": {"name": "DR Congo", "cca2": "CD", "lat": -3.5, "lon": 23.4},
      "CIV": {"name": "C√¥te d'Ivoire", "cca2": "CI", "lat": 7.5, "lon": -5.5},
      "DJI": {"name": "Djibouti", "cca2": "DJ", "lat": 11.8, "lon": 42.5},
      "EGY": {"name": "Egypt", "cca2": "EG", "lat": 26.8, "lon": 30.8},
      "GNQ": {"name": "Equatorial Guinea", "cca2": "GQ", "lat": 1.5, "lon": 10.0},
      "ERI": {"name": "Eritrea", "cca2": "ER", "lat": 15.0, "lon": 39.0},
      "SWZ": {"name": "Eswatini", "cca2": "SZ", "lat": -26.5, "lon": 31.5},
      "ETH": {"name": "Ethiopia", "cca2": "ET", "lat": 9.1, "lon": 40.5},
      "GAB": {"name": "Gabon", "cca2": "GA", "lat": -0.6, "lon": 11.6},
      "GMB": {"name": "Gambia", "cca2": "GM", "lat": 13.4, "lon": -16.5},
      "GHA": {"name": "Ghana", "cca2": "GH", "lat": 7.9, "lon": -1.0},
      "GIN": {"name": "Guinea", "cca2": "GN", "lat": 10.4, "lon": -10.8},
      "GNB": {"name": "Guinea-Bissau", "cca2": "GW", "lat": 12.0, "lon": -15.0},
      "KEN": {"name": "Kenya", "cca2": "KE", "lat": 0.0, "lon": 37.9},
      "LSO": {"name": "Lesotho", "cca2": "LS", "lat": -29.5, "lon": 28.5},
      "LBR": {"name": "Liberia", "cca2": "LR", "lat": 6.4, "lon": -9.4},
      "LBY": {"name": "Libya", "cca2": "LY", "lat": 25.0, "lon": 17.0},
      "MDG": {"name": "Madagascar", "cca2": "MG", "lat": -19.0, "lon": 46.7},
      "MWI": {"name": "Malawi", "cca2": "MW", "lat": -13.3, "lon": 34.3},
      "MLI": {"name": "Mali", "cca2": "ML", "lat": 17.3, "lon": -3.99},
      "MRT": {"name": "Mauritania", "cca2": "MR", "lat": 20.0, "lon": -10.0},
      "MUS": {"name": "Mauritius", "cca2": "MU", "lat": -20.2, "lon": 57.5},
      "MAR": {"name": "Morocco", "cca2": "MA", "lat": 32.0, "lon": -5.0},
      "MOZ": {"name": "Mozambique", "cca2": "MZ", "lat": -18.6, "lon": 35.5},
      "NAM": {"name": "Namibia", "cca2": "NA", "lat": -22.1, "lon": 17.2},
      "NER": {"name": "Niger", "cca2": "NE", "lat": 17.6, "lon": 8.1},
      "NGA": {"name": "Nigeria", "cca2": "NG", "lat": 9.1, "lon": 8.7},
      "RWA": {"name": "Rwanda", "cca2": "RW", "lat": -1.9, "lon": 29.9},
      "STP": {"name": "S√£o Tom√© and Pr√≠ncipe", "cca2": "ST", "lat": 0.3, "lon": 6.7},
      "SEN": {"name": "Senegal", "cca2": "SN", "lat": 14.4, "lon": -14.5},
      "SYC": {"name": "Seychelles", "cca2": "SC", "lat": -4.6, "lon": 55.5},
      "SLE": {"name": "Sierra Leone", "cca2": "SL", "lat": 8.46, "lon": -11.79},
      "SOM": {"name": "Somalia", "cca2": "SO", "lat": 5.15, "lon": 46.2},
      "ZAF": {"name": "South Africa", "cca2": "ZA", "lat": -30.6, "lon": 22.9},
      "SSD": {"name": "South Sudan", "cca2": "SS", "lat": 7.0, "lon": 30.0},
      "SDN": {"name": "Sudan", "cca2": "SD", "lat": 15.0, "lon": 30.0},
      "TZA": {"name": "Tanzania", "cca2": "TZ", "lat": -6.37, "lon": 34.89},
      "TGO": {"name": "Togo", "cca2": "TG", "lat": 8.0, "lon": 1.2},
      "TUN": {"name": "Tunisia", "cca2": "TN", "lat": 34.0, "lon": 9.0},
      "UGA": {"name": "Uganda", "cca2": "UG", "lat": 1.37, "lon": 32.3},
      "ZMB": {"name": "Zambia", "cca2": "ZM", "lat": -13.14, "lon": 27.85},
      "ZWE": {"name": "Zimbabwe", "cca2": "ZW", "lat": -19.0, "lon": 29.9}
    })
  </script>
  <script id="15" type="application/vnd.observable.javascript">
    africaCountries = Object.keys(africaCountriesData).map(code => ({
      code: code,
      name: africaCountriesData[code].name,
      cca2: africaCountriesData[code].cca2,
      lat: africaCountriesData[code].lat,
      lon: africaCountriesData[code].lon
    })).sort((a, b) => a.name.localeCompare(b.name))

  </script>
  <script id="17" type="application/vnd.observable.javascript">
    countryColorScaleDeep = d3.scaleOrdinal()
      .domain(africaCountries.map(c => c.name))
      .range([
        "#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00",
        "#a65628", "#f781bf", "#999999", "#66c2a5", "#fc8d62",
        "#8da0cb", "#e78ac3", "#a6d854", "#ffd92f", "#e5c494",
        "#b3b3b3", "#1b9e77", "#d95f02", "#7570b3", "#e7298a",
        "#66a61e", "#e6ab02", "#a6761d", "#666666", "#7fc97f",
        "#beaed4", "#fdc086", "#ffff99", "#386cb0", "#f0027f",
        "#bf5b17", "#666666", "#1a9850", "#fdae61", "#abd9e9",
        "#2c7bb6", "#d7191c", "#fdae61", "#abd9e9", "#2c7bb6"
      ])
  </script>
  <script id="19" type="application/vnd.observable.javascript">
    pestSpecies = [
      {id: "faw", name: "Fall armyworm", scientific: "Spodoptera frugiperda"},
      {id: "dl", name: "Desert locust", scientific: "Schistocerca gregaria"},
      {id: "sr", name: "Stem rust", scientific: "Puccinia graminis"},
      {id: "cbm", name: "Cassava Brown Streak", scientific: "Cassava brown streak virus"},
      {id: "mln", name: "Maize Lethal Necrosis", scientific: "MLN virus complex"}
    ]
  </script>
  <script id="148" type="application/vnd.observable.javascript">
    countries = [
      // East Africa
      {name: "Kenya", code: "KE", region: "East Africa"},
      {name: "Uganda", code: "UG", region: "East Africa"},
      {name: "Tanzania", code: "TZ", region: "East Africa"},
      {name: "Rwanda", code: "RW", region: "East Africa"},
      {name: "Ethiopia", code: "ET", region: "East Africa"},
      {name: "Sudan", code: "SD", region: "East Africa"},
      {name: "South Sudan", code: "SS", region: "East Africa"},
      {name: "Eritrea", code: "ER", region: "East Africa"},
      {name: "Somalia", code: "SO", region: "East Africa"},
      {name: "Djibouti", code: "DJ", region: "East Africa"},
      {name: "Burundi", code: "BI", region: "East Africa"},

      // West
      {name: "Nigeria", code: "NG", region: "West Africa"},
      {name: "Ghana", code: "GH", region: "West Africa"},
      {name: "Senegal", code: "SN", region: "West Africa"},
      {name: "Mali", code: "ML", region: "West Africa"},
      {name: "Burkina Faso", code: "BF", region: "West Africa"},
      {name: "Niger", code: "NE", region: "West Africa"},
      {name: "Ivory Coast", code: "CI", region: "West Africa"},
      {name: "Guinea", code: "GN", region: "West Africa"},
      {name: "Benin", code: "BJ", region: "West Africa"},
      {name: "Togo", code: "TG", region: "West Africa"},
      {name: "Sierra Leone", code: "SL", region: "West Africa"},
      {name: "Liberia", code: "LR", region: "West Africa"},
      {name: "Mauritania", code: "MR", region: "West Africa"},
      {name: "Gambia", code: "GM", region: "West Africa"},
      {name: "Guinea-Bissau", code: "GW", region: "West Africa"},
      {name: "Cape Verde", code: "CV", region: "West Africa"},

      // Mid
      {name: "Cameroon", code: "CM", region: "Central Africa"},
      {name: "DRC", code: "CD", region: "Central Africa"},
      {name: "CAR", code: "CF", region: "Central Africa"},
      {name: "Chad", code: "TD", region: "Central Africa"},
      {name: "Gabon", code: "GA", region: "Central Africa"},
      {name: "Congo", code: "CG", region: "Central Africa"},
      {name: "Equatorial Guinea", code: "GQ", region: "Central Africa"},
      {name: "Sao Tome", code: "ST", region: "Central Africa"},

      // South
      {name: "South Africa", code: "ZA", region: "Southern Africa"},
      {name: "Zimbabwe", code: "ZW", region: "Southern Africa"},
      {name: "Zambia", code: "ZM", region: "Southern Africa"},
      {name: "Mozambique", code: "MZ", region: "Southern Africa"},
      {name: "Botswana", code: "BW", region: "Southern Africa"},
      {name: "Namibia", code: "NA", region: "Southern Africa"},
      {name: "Angola", code: "AO", region: "Southern Africa"},
      {name: "Malawi", code: "MW", region: "Southern Africa"},
      {name: "Madagascar", code: "MG", region: "Southern Africa"},
      {name: "Mauritius", code: "MU", region: "Southern Africa"},
      {name: "Lesotho", code: "LS", region: "Southern Africa"},
      {name: "Eswatini", code: "SZ", region: "Southern Africa"},
      {name: "Seychelles", code: "SC", region: "Southern Africa"},
      {name: "Comoros", code: "KM", region: "Southern Africa"},

      // North
      {name: "Egypt", code: "EG", region: "North Africa"},
      {name: "Libya", code: "LY", region: "North Africa"},
      {name: "Tunisia", code: "TN", region: "North Africa"},
      {name: "Algeria", code: "DZ", region: "North Africa"},
      {name: "Morocco", code: "MA", region: "North Africa"}
    ]


  </script>
  <script id="215" type="application/vnd.observable.javascript">
    pestOccurrenceData = {
      try {
        const occurrences = [];

        for (const pestStr of selectedPests) {
          const pest = pestSpecies.find(p => pestStr.includes(p.scientific));
          if (!pest) continue;

          const speciesUrl = `https://api.gbif.org/v1/species/match?name=${encodeURIComponent(pest.scientific)}`;
          const speciesResponse = await fetch(speciesUrl);

          if (speciesResponse.ok) {
            const speciesData = await speciesResponse.json();
            const usageKey = speciesData.usageKey;

            if (usageKey) {
              const countryList = analysisMode === "all" ? 
                africaCountries.map(c => c.cca2).join(',') :
                analysisMode === "multi" ? 
                selectedCountries.map(name => africaCountries.find(c => c.name === name)?.cca2).filter(Boolean).join(',') :
                africaCountries.find(c => c.name === selectedCountry)?.cca2;

              const occUrl = `https://api.gbif.org/v1/occurrence/search?taxonKey=${usageKey}&country=${countryList}&limit=0`;
              const occResponse = await fetch(occUrl);

              if (occResponse.ok) {
                const occData = await occResponse.json();
                occurrences.push({
                  pest: pest.name,
                  scientific: pest.scientific,
                  count: occData.count || 0,
                  year: new Date().getFullYear()
                });
              }
            }
          }
        }

        return occurrences;
      } catch (error) {
        console.error("Failed to load GBIF data:", error);
        // Fallback data
        return selectedPests.map(pestStr => {
          const pest = pestSpecies.find(p => pestStr.includes(p.scientific));
          return {
            pest: pest?.name || "Unknown",
            scientific: pest?.scientific || "Unknown",
            count: Math.floor(Math.random() * 1000 + 100),
            year: new Date().getFullYear()
          };
        });
      }
    }

  </script>
  <script id="231" type="application/vnd.observable.javascript">

    cropYieldTrends = {
      try {
        const trends = [];
        const years = [2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023];

        const targetCountries = analysisMode === "single" ? 
          [selectedCountry] :
          analysisMode === "multi" ? 
          selectedCountries.slice(0, 5) : 
          ["Kenya", "Nigeria", "Ethiopia", "South Africa", "Egypt"];

        for (const countryName of targetCountries) {
          const country = africaCountries.find(c => c.name === countryName);
          if (!country) continue;

          // loading historical data
          const url = `${worldBankAPI}/country/${country.cca2}/indicator/AG.YLD.CREL.KG?format=json&date=2015:2023&per_page=20`;
          const response = await fetch(url);

          if (response.ok) {
            const data = await response.json();
            if (data[1] && data[1].length > 0) {
              // every year
              years.forEach(year => {
                const yearData = data[1].find(d => d.date == year && d.value !== null);
                if (yearData) {
                  trends.push({
                    country: countryName,
                    year: year,
                    yield: Math.round(yearData.value),
                    pestImpact: Math.round(100 - (yearData.value / 50)) // Á∞°ÂåñÁöÑÂÆ≥Ëü≤ÂΩ±Èüø‰º∞ÁÆó
                  });
                }
              });
            }
          }
        }

        // fall back
        if (trends.length === 0) {
          targetCountries.forEach(country => {
            years.forEach(year => {
              trends.push({
                country: country,
                year: year,
                yield: Math.round(2000 + Math.random() * 1000),
                pestImpact: Math.round(20 + Math.random() * 30)
              });
            });
          });
        }

        return trends;
      } catch (error) {
        console.error("Failed to load yield trends:", error);
        return [];
      }
    }
  </script>
  <script id="150" type="application/vnd.observable.javascript">

    pestRiskData = {
      try {

        const selectedCountryList = analysisMode === "single" ? 
          [selectedCountry] : 
          analysisMode === "multi" ? 
          selectedCountries : 
          africaCountries.map(c => c.name);

        const results = [];

        for (const countryName of selectedCountryList) {
          const country = africaCountries.find(c => c.name === countryName);
          if (!country) continue;

          // Data from World Bank
          let cropIndex = null;
          let pestManagement = null;

          try {
            // productivity
            const cropUrl = `${worldBankAPI}/country/${country.cca2}/indicator/AG.PRD.CROP.XD?format=json&date=2020:2023&per_page=10`;
            const cropResponse = await fetch(cropUrl);
            if (cropResponse.ok) {
              const cropData = await cropResponse.json();
              if (cropData[1] && cropData[1].length > 0) {
                cropIndex = cropData[1].find(d => d.value !== null)?.value || 100;
              }
            }

            // crop volume (pest anti index)
            const yieldUrl = `${worldBankAPI}/country/${country.cca2}/indicator/AG.YLD.CREL.KG?format=json&date=2020:2023&per_page=10`;
            const yieldResponse = await fetch(yieldUrl);
            if (yieldResponse.ok) {
              const yieldData = await yieldResponse.json();
              if (yieldData[1] && yieldData[1].length > 0) {
                const yieldValue = yieldData[1].find(d => d.value !== null)?.value;
                pestManagement = yieldValue ? (10000 / yieldValue) * 10 : 50; // ÂèçÂêëË®àÁÆóÂÆ≥Ëü≤Â£ìÂäõ
              }
            }
          } catch (error) {
            console.error(`Error loading data for ${countryName}:`, error);
          }

          // Risk score
          const baseRisk = 50; 
          const tempImpact = tempChange * 5; 
          const cropVulnerability = cropIndex ? (200 - cropIndex) / 2 : 50;
          const pestPressure = pestManagement || 50;

          const riskScore = Math.min(100, Math.max(0, 
            baseRisk + tempImpact + (cropVulnerability - 50) * 0.5 + (pestPressure - 50) * 0.3
          ));

          results.push({
            country: countryName,
            region: countries.find(c => c.name === countryName)?.region || "Unknown",
            riskScore: Math.round(riskScore),
            pestCount: selectedPests.length,
            affectedArea: Math.round(20 + (riskScore / 100) * 50), 
            cropIndex: cropIndex ? Math.round(cropIndex) : null,
            temperature: tempChange,
            dataSource: cropIndex ? "World Bank API" : "Model Estimate"
          });
        }

        return results.sort((a, b) => b.riskScore - a.riskScore);

      } catch (error) {
        console.error("Failed to load pest risk data:", error);
        // FallbackÊï∏Êìö
        return countries.map(c => ({
          country: c.name,
          region: c.region,
          riskScore: Math.floor(Math.random() * 40 + 40),
          pestCount: Math.floor(Math.random() * 5 + 3),
          affectedArea: Math.floor(Math.random() * 30 + 20),
          dataSource: "Fallback Data"
        }));
      }
    }

  </script>
</notebook>
