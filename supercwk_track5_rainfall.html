<!doctype html>
<notebook theme="air">
  <title>üåßÔ∏è Track 5 ‚Äî Rainfall Reliability Explorer</title>
  <script id="0" type="text/markdown">
    # üåßÔ∏è Track 5 ‚Äî Rainfall Reliability Explorer

    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
      <span style="padding: 4px 12px; background: #e3f2fd; border: 1px solid #2196F3; border-radius: 16px; font-size: 12px; color: #0d47a1;">Multi-Country Analysis</span>
      <span style="padding: 4px 12px; background: #e3f2fd; border: 1px solid #2196F3; border-radius: 16px; font-size: 12px; color: #0d47a1;">Kenya Focus Available</span>
      <span style="padding: 4px 12px; background: #e3f2fd; border: 1px solid #2196F3; border-radius: 16px; font-size: 12px; color: #0d47a1;">Decision Support Tool</span>
    </div>
  </script>
  <script id="260" type="text/html">
    <nav style="padding: 10px 12px; border: 1px dashed #bbb; border-radius: 6px; background: #fff; margin-bottom: 16px; font-size: 14px;">
        <strong>Navigate Sections:</strong>
        <a onclick="document.getElementById('opening-scene').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #1976d2; margin: 0 10px; cursor: pointer;">Introduction</a> |
        <a onclick="document.getElementById('story-navigator').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #1976d2; margin: 0 10px; cursor: pointer;">üìç Story Navigator</a> |
        <a onclick="document.getElementById('q1').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #1976d2; margin: 0 10px; cursor: pointer;">Q1: Onset & LGP</a> |
        <a onclick="document.getElementById('q2').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #1976d2; margin: 0 10px; cursor: pointer;">Q2: Shifts & Trends</a> |
        <a onclick="document.getElementById('q3').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #1976d2; margin: 0 10px; cursor: pointer;">Q3: Crop Impact</a> |
        <a onclick="document.getElementById('q4').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #1976d2; margin: 0 10px; cursor: pointer;">Q4: Risk Areas</a> |
        <a onclick="document.getElementById('q5').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #1976d2; margin: 0 10px; cursor: pointer;">Q5: Irrigation</a> |
        <a onclick="document.getElementById('conclusion').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #1976d2; margin: 0 10px; cursor: pointer;">Conclusion</a> |
        <a onclick="document.getElementById('methods').scrollIntoView({behavior: 'smooth'}); return false;" 
           href="#" style="color: #1976d2; margin: 0 10px; cursor: pointer;">üìö Methods & Sources</a>
      </nav>

  </script>
  <script id="7" type="text/markdown">

      <div id="opening-scene" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #1976d2; border-radius: 8px; padding: 20px; margin: 20px 0;">
        <h2>Introduction</h2>
        <h3>üéØ Prologue: The Rainfall Challenge Across Africa</h3>

        <p style="line-height: 1.8;">
        <strong>The Context:</strong> Across Africa, from Kenya's 47 counties to the Sahel's vast drylands, smallholder farmers face an intensifying challenge: unpredictable rainfall patterns. In Kenya alone, recent droughts (2022-2023) affected over 4.5 million people, while floods in 2020 displaced thousands. This volatility spans the continent‚Äîfrom Ethiopia's highlands to South Africa's maize belt.
        </p>

        <p style="line-height: 1.8;">
        <strong>The Critical Problem:</strong> Countries experiencing both <strong>delayed rainfall onset AND shortened growing seasons</strong> face a compound crisis. Farmers have less predictable windows to plant, reduced time for crops to mature, and increased risk of harvest failure. In Kenya's Turkana and Marsabit counties, for example, the growing season has shortened by 20% over the past three decades.
        </p>

        <p style="line-height: 1.8;">
        <strong>What This Tool Reveals:</strong> Through five analytical acts, this explorer traces rainfall patterns using 30 years of climate data from the Africa Agriculture Adaptation Atlas. Each act addresses a key question: (I) Monthly patterns and seasonality, (II) Dry month frequency and trends, (III) Season onset and length, (IV) Long-term shifts, and (V) Investment priorities for climate adaptation.
        </p>

        <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 6px; padding: 12px; margin-top: 16px;">
          <h4 style="color: #2e7d32; margin-top: 0;">üá∞üá™ Special Focus: Kenya's Agricultural Zones</h4>
          <p style="margin: 0;">Kenya serves as a critical case study with its diverse agro-ecological zones‚Äîfrom arid northern counties (Turkana, Marsabit) receiving <200mm annually, to high-potential areas like Trans Nzoia with >1,200mm. Select Kenya in the country list to explore detailed county-level patterns crucial for national agricultural planning.</p>
        </div>
      </div>

  </script>
  <script id="26" type="text/markdown">
    <div id="story-navigator" style="border-radius: 8px; padding: 5px; margin: 20px 0;">
        <h2>üìç Story Navigator ‚Äî Select Countries & Configure Analysis</h2>
  </script>
  <script id="28" type="application/vnd.observable.javascript">
    viewof selectionMode = Inputs.radio(
      ["single", "multiple", "all", "focus_kenya"],
      {
        label: "Selection Mode:",
        value: "multiple",
        format: x => ({
          single: "Single Country",
          multiple: "Multi-Country Comparison",
          all: "‚úì All Countries",  
          focus_kenya: "Kenya County Analysis",
        }[x])
      }
    )


  </script>
  <script id="31" type="application/vnd.observable.javascript">
    viewof selectedCountries = {
      if (selectionMode === "single") {
        return Inputs.select(
          countryList.map(c => c.name),
          {
            label: "Select Country:",
            value: "Kenya"
          }
        )
      } 
      else if (selectionMode === "multiple") {
        return Inputs.checkbox(
          countryList.map(c => c.name),
          {
            label: "Select Countries (click to toggle):",
            value: ["Kenya", "Uganda", "Tanzania", "Ethiopia", "Rwanda"]
          }
        )
      } 
      else if (selectionMode === "all") {
        const div = html`
          <div>
            <label style="display: block; font-size: 14px; margin-bottom: 8px;">Countries Selected:</label>
            <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; border: 1px solid #2196F3;">
              <strong>‚úì All ${countryList.length} African countries selected</strong>
              <div style="margin-top: 8px; font-size: 12px; color: #666;">
                ${countryList.length} countries from all regions are included
              </div>
            </div>
          </div>
        `;

        Object.defineProperty(div, 'value', {
          get: () => countryList.map(c => c.name)
        });

        return div;
      }
      else if (selectionMode === "focus_kenya") {
        return Inputs.checkbox(
          kenyaCounties.map(c => c.name),
          {
            label: "Select Kenya Counties (click to toggle):",
            value: ["Turkana", "Marsabit", "Trans Nzoia", "Kiambu", "Machakos"]
          }
        )
      }
      else if (selectionMode === "all_kenya") {

        const div = html`
          <div>
            <label style="display: block; font-size: 14px; margin-bottom: 8px;">Kenya Counties Selected:</label>
            <div style="background: #c8e6c9; padding: 12px; border-radius: 4px; border: 1px solid #4CAF50;">
              <strong>‚úì All ${kenyaCounties.length} Kenya counties selected</strong>
              <div style="margin-top: 8px; font-size: 12px; color: #666;">
                All counties in Kenya are included in the analysis
              </div>
            </div>
          </div>
        `;


        Object.defineProperty(div, 'value', {
          get: () => kenyaCounties.map(c => c.name),
          enumerable: true
        });

        return div;
      }
    }
  </script>
  <script id="38" type="application/vnd.observable.javascript">
    viewof timePeriod = Inputs.select(
      ["2001-2020", "2011-2020", "1991-2020"],
      {
        label: "Analysis Period:",
        value: "1991-2020",
        format: x => ({
          "2001-2020": "2001‚Äì2020 (Recent 20 years)",
          "2011-2020": "2011‚Äì2020 (Last decade)",
          "1991-2020": "1991‚Äì2020 (30-year baseline)"
        }[x])
      }
    )
  </script>
  <script id="41" type="text/markdown">
    **Analysis Thresholds:**
  </script>
  <script id="45" type="application/vnd.observable.javascript">
    viewof dryThreshold = Inputs.range(
      [0.5, 5],
      {
        value: 1.0,
        step: 0.5,
        label: "Dry-month threshold (mm/day):"
      }
    )

  </script>
  <script id="52" type="application/vnd.observable.javascript">

    viewof lgpThreshold = Inputs.range(
      [30, 100],
      {
        value: 50,
        step: 10,
        label: "Season onset threshold (mm/month):"
      }
    )
  </script>
  <script id="55" type="application/vnd.observable.javascript">
    viewof feasibility = Inputs.select(
      ["all", "high", "medium", "low"],
      {
        label: "Implementation Feasibility:",
        value: "all",
        format: x => ({
          all: "All interventions",
          high: "High feasibility only",
          medium: "Medium-high feasibility",
          low: "Include low feasibility"
        }[x])
      }
    )
  </script>
  <script id="58" type="application/vnd.observable.javascript">
    viewof runAnalysis = Inputs.button("üîÑ Run Analysis", {value: 0})
  </script>
  <script id="199" type="application/vnd.observable.javascript">
    progressStatus = {
      if (runAnalysis > 0) {
        const steps = [
          "Loading climate data...",
          "Processing rainfall patterns...",
          "Calculating LGP values...",
          "Analyzing trends...",
          "Generating visualizations...",
          "Complete!"
        ];

        let currentStep = 0;
        const div = html`<div style="background: #f6f8fa; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin: 10px 0;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <progress value="0" max="100" style="flex: 1; height: 12px;"></progress>
            <span style="font-size: 12px; color: #666; min-width: 140px;">Initializing...</span>
          </div>
        </div>`;

        const progress = div.querySelector('progress');
        const status = div.querySelector('span');

        const interval = setInterval(() => {
          if (currentStep < steps.length) {
            progress.value = (currentStep / (steps.length - 1)) * 100;
            status.textContent = steps[currentStep];
            currentStep++;
          } else {
            clearInterval(interval);
          }
        }, 500);

        return div;
      }
      return html`<div></div>`;
    }
  </script>
  <script id="388" type="text/html">
    <div style="background: rgba(46, 118, 54, 0.1); border-radius: 8px; padding: 20px; margin: 20px 0;">
      <h3>üí° How to Start:</h3>
      <ol>
        <li>Select your countries of interest from the dropdown menu above</li>
        <li>Click the <strong>"Run Analysis"</strong> button in the Story Navigator Section</li>
        <li>All visualizations will automatically update with your selected data</li>
      </ol>

      <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #FFC107; padding: 10px; margin-top: 15px;">
        <strong>‚è±Ô∏è Loading Information:</strong><br>
        Data is fetched from multiple APIs in real-time. Most visualizations load within 30 seconds, 
        but complex analyses may take 1-3 minutes. 
      </div>
    </div>
  </script>
  <script id="80" type="text/markdown">
    <div id="q1" style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; width: 100%; box-sizing: border-box;">

    <h2 style="margin: 0 0 8px 0; padding: 0; line-height: 1.3;">Q1: When does the rainy season start, and what is the typical length and year-to-year variability of the length of growing period (LGP) across counties?</h2>

    <div style="font-size: 14px; color: #666; margin-top: 8px; font-style: italic;">
    ‚òÅÔ∏è ACT I ‚Äî Monthly Patterns & Seasonality
    </div>

    <p style="margin-top: 16px; line-height: 1.6;">
    Through 30 years of monthly rainfall data, we identify the rhythm of rain‚Äîwhen seasons begin, peak, and fade. This reveals which regions have reliable growing windows versus those facing erratic onset and duration.
    </p>

    </div>
  </script>
  <script id="82" type="application/vnd.observable.javascript">
    monthlyRainfallChart = {
      const container = html`<div style="position: relative; min-height: 500px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(227,242,253,.7),rgba(227,242,253,.7) 10px,rgba(187,222,251,.8) 10px,rgba(187,222,251,.8) 20px); font-weight: 700; color: #0d47a1; border-radius: 8px;">
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
              <div style="font-size: 18px; margin-bottom: 8px;">
                Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
              </div>
            </div>
          </div>` :
          html`<div>Loading rainfall data...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        const monthlyData = processedData.flatMap(d => {
          const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
          return months.map((month, i) => ({
            month,
            rainfall: d.rainfall / 12 * (1 + 0.5 * Math.sin(2 * Math.PI * i / 12 - Math.PI / 2)),
            location: d.name,
            color: d.color
          }));
        });

        const chart = Plot.plot({
          title: "Monthly Rainfall Patterns by Country/County",
          subtitle: `Period: ${timePeriod} | ${processedData.length} location(s) selected`,
          width: 1200,  
          height: 500,  
          marginLeft: 80,
          marginBottom: 100,
          marginRight: 150, 
          y: {
            label: "‚Üë Average Rainfall (mm)",
            domain: [0, Math.max(...monthlyData.map(d => d.rainfall)) * 1.1],
            grid: true
          },
          x: {
            label: "Month ‚Üí",
            domain: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
          },
          color: {
            legend: true,
            domain: processedData.map(d => d.name),
            range: processedData.map(d => d.color)
          },
          marks: [
            Plot.line(monthlyData, {
              x: "month",
              y: "rainfall",
              stroke: "location",
              strokeWidth: 2,
              curve: "catmull-rom"
            }),
            Plot.dot(monthlyData.filter((d, i) => i % Math.max(1, Math.floor(monthlyData.length / 100)) === 0), {
              x: "month",
              y: "rainfall",
              fill: "location",
              r: 3,
              tip: true
            })
          ]
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }
      return container;
    }
  </script>
  <script id="84" type="application/vnd.observable.javascript">
    lgpComparisonChart = {
      const container = html`<div style="position: relative; min-height: 600px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe; margin-top: 20px;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(227,242,253,.7),rgba(227,242,253,.7) 10px,rgba(187,222,251,.8) 10px,rgba(187,222,251,.8) 20px); font-weight: 700; color: #0d47a1; border-radius: 8px;">
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">üìà</div>
              <div style="font-size: 18px;">Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing </div>
            </div>
          </div>` :
          html`<div>Calculating LGP values...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        const data = processedData;

        // adjust height based on the number of the selection
        const dynamicHeight = Math.max(600, data.length * 15);

        const chart = Plot.plot({
          title: "Length of Growing Period (LGP) Comparison",
          subtitle: `Based on ${lgpThreshold}mm/month threshold | Data: Real-time`,
          width: 1200,  
          height: dynamicHeight, 
          marginLeft: 150,  
          marginBottom: 80,
          x: {
            label: "LGP (days) ‚Üí",
            domain: [0, Math.max(...data.map(d => d.lgp)) * 1.2],
            grid: true
          },
          y: {
            label: null,
            domain: data.map(d => d.name)
          },
          color: {
            type: "ordinal",
            scheme: "RdYlGn",
            domain: ["very high", "high", "medium", "low"],
            legend: true
          },
          marks: [
            Plot.barX(data, {
              x: "lgp",
              y: "name",
              fill: "risk",
              sort: {y: "-x"},
              title: d => `${d.name}\nLGP: ${d.lgp} days\nRainfall: ${d.rainfall}mm\nRisk: ${d.risk}`
            }),
            Plot.ruleX([90], {
              stroke: "red",
              strokeDasharray: "4,2",
              strokeOpacity: 0.5
            }),
            Plot.text(data, {
              x: "lgp",
              y: "name",
              text: d => `${d.lgp}d`,
              dx: 5,
              fontSize: 10,
              fontWeight: "bold"
            })
          ]
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }
      return container;
    }
  </script>
  <script id="93" type="text/markdown">
    <div id="q2" style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; width: 100%; box-sizing: border-box;">

    <h2 style="margin: 0 0 8px 0; padding: 0; line-height: 1.3;">Q2: Which counties are experiencing significant shifts in onset or shortening of the rainy season?</h2>

    <div style="font-size: 14px; color: #666; margin-top: 8px; font-style: italic;">
    ‚òÅÔ∏è ACT II ‚Äî Dry Month Frequency & Trends
    </div>

    <p style="margin-top: 16px; line-height: 1.6;">
    We analyze the frequency of dry months (rainfall < ${dryThreshold}mm/day) and track whether these are increasing. Counties with rising dry-month frequency face mounting agricultural stress.
    </p>

    </div>
  </script>
  <script id="90" type="application/vnd.observable.javascript">
    trendAnalysisChart = {
      const container = html`<div style="position: relative; min-height: 500px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(227,242,253,.7),rgba(227,242,253,.7) 10px,rgba(187,222,251,.8) 10px,rgba(187,222,251,.8) 20px); font-weight: 700; color: #0d47a1; border-radius: 8px;">
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">üìÖ</div>
              <div style="font-size: 18px;">Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing </div>
            </div>
          </div>` :
          html`<div>Analyzing trends...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        const historicalData = [];
        const years = [2018, 2019, 2020, 2021, 2022, 2023];

        // Try to fetch historical data
        for (const location of processedData) {

          if (selectionMode === "focus_kenya" || selectionMode === "all_kenya") {
            try {
              const response = await fetch(
                `https://climate-api.open-meteo.com/v1/climate?latitude=${location.lat}&longitude=${location.lon}&start_date=2018-01-01&end_date=2023-12-31&models=EC_Earth3P_HR&yearly=precipitation_sum`
              );

              if (response.ok) {
                const data = await response.json();
                const yearlyData = data.yearly?.precipitation_sum || [];

                years.forEach((year, idx) => {
                  historicalData.push({
                    location: location.name,
                    year: year,
                    rainfall: yearlyData[idx] || location.rainfall,
                    lgp: Math.round((yearlyData[idx] || location.rainfall) / 5),
                    dataSource: yearlyData[idx] ? "Climate API" : "Estimated"
                  });
                });
              } else {
                // FallbackÔºöbased on the current variation
                years.forEach(year => {
                  const variation = 0.9 + Math.random() * 0.2; // ¬±10% variation
                  historicalData.push({
                    location: location.name,
                    year: year,
                    rainfall: location.rainfall * variation,
                    lgp: location.lgp * variation,
                    dataSource: "Estimated"
                  });
                });
              }
            } catch (error) {
              // Fallback
              years.forEach(year => {
                const variation = 0.9 + Math.random() * 0.2;
                historicalData.push({
                  location: location.name,
                  year: year,
                  rainfall: location.rainfall * variation,
                  lgp: location.lgp * variation,
                  dataSource: "Estimated"
                });
              });
            }
          } else {

            years.forEach(year => {
              // analyze based on the real annual change mode
              const trendFactor = 1 - (2023 - year) * 0.01; // slightly decrease
              const randomFactor = 0.95 + Math.random() * 0.1; // ¬±5% randomness

              historicalData.push({
                location: location.name,
                year: year,
                rainfall: location.rainfall * trendFactor * randomFactor,
                lgp: location.lgp * trendFactor * randomFactor,
                dataSource: location.dataSource || "Estimated"
              });
            });
          }
        }

        const chart = Plot.plot({
          title: "Rainfall and LGP Trends (2018-2023)",
          subtitle: `Data: ${historicalData[0]?.dataSource || "Mixed"} | Showing year-to-year variability`,
          width: 1200,
          height: 500,
          marginBottom: 80,
          marginRight: 150,
          x: {
            label: "Year ‚Üí",
            tickFormat: d => d.toString()
          },
          y: {
            label: "‚Üë Annual Rainfall (mm)",
            grid: true
          },
          color: {
            legend: true
          },
          marks: [
            Plot.line(historicalData, {
              x: "year",
              y: "rainfall",
              stroke: "location",
              strokeWidth: 2,
              marker: "circle"
            }),
            Plot.dot(historicalData.filter((d, i) => i % Math.max(1, Math.floor(historicalData.length / 100)) === 0), {
              x: "year",
              y: "rainfall",
              fill: "location",
              r: 4,
              tip: true,
              title: d => `${d.location}\n${d.year}: ${d.rainfall.toFixed(0)}mm\nData: ${d.dataSource}`
            }),
            Plot.ruleY([500], {
              stroke: "orange",
              strokeDasharray: "4,2",
              strokeOpacity: 0.5
            })
          ]
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }
      return container;
    }


  </script>
  <script id="96" type="text/markdown">
    <div id="q3" style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; width: 100%; box-sizing: border-box;">

    <h2 style="margin: 0 0 8px 0; padding: 0; line-height: 1.3;">Q3: What do these rainfall trends imply for key rain-fed crops (maize, sorghum, fodder) and for livestock populations (cattle, goats, sheep, poultry)?</h2>

    <div style="font-size: 14px; color: #666; margin-top: 8px; font-style: italic;">
    ‚òÅÔ∏è ACT III ‚Äî Implications for Key Crops & Livestock
    </div>

    <p style="margin-top: 16px; line-height: 1.6;">
    Different agricultural systems have varying water requirements. We map rainfall adequacy against crop needs to identify zones suitable for different farming strategies.
    </p>

    </div>
  </script>
  <script id="98" type="application/vnd.observable.javascript">

    cropSuitabilityMatrix = {
      const container = html`<div style="position: relative; min-height: 700px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(227,242,253,.7),rgba(227,242,253,.7) 10px,rgba(187,222,251,.8) 10px,rgba(187,222,251,.8) 20px); font-weight: 700; color: #0d47a1; border-radius: 8px;">
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">üåæ</div>
              <div style="font-size: 18px;">Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing </div>
            </div>
          </div>` :
          html`<div>Analyzing crop suitability...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        const crops = ["Maize", "Sorghum", "Millet", "Beans", "Cassava", "Livestock"];
        const suitabilityData = [];

        processedData.forEach(location => {
          crops.forEach(crop => {
            let suitability;
            if (crop === "Maize") {
              suitability = location.rainfall >= 600 ? 100 : location.rainfall >= 450 ? 60 : 30;
            } else if (crop === "Sorghum" || crop === "Millet") {
              suitability = location.rainfall >= 400 ? 100 : location.rainfall >= 300 ? 70 : 40;
            } else if (crop === "Beans") {
              suitability = location.rainfall >= 500 ? 100 : location.rainfall >= 400 ? 65 : 35;
            } else if (crop === "Cassava") {
              suitability = location.rainfall >= 500 ? 90 : location.rainfall >= 350 ? 70 : 50;
            } else {
              suitability = location.rainfall >= 300 ? 80 : location.rainfall >= 200 ? 60 : 40;
            }

            suitabilityData.push({
              location: location.name,
              crop: crop,
              suitability: suitability,
              rainfall: location.rainfall
            });
          });
        });

        // dynamic adjust height
        const dynamicHeight = Math.max(700, processedData.length * 20);

        const chart = Plot.plot({
          title: "Crop and Livestock Suitability Assessment",
          subtitle: `Based on rainfall requirements | ${processedData.length} locations analyzed`,
          width: 1200,  
          height: dynamicHeight, 
          marginLeft: 150,
          marginBottom: 100,
          x: {
            label: "Crop/Livestock Type ‚Üí",
            tickRotate: -45
          },
          y: {
            label: "‚Üê Location"
          },
          color: {
            type: "sequential",
            scheme: "RdYlGn",
            domain: [0, 100],
            label: "Suitability (%)",
            legend: true
          },
          marks: [
            Plot.cell(suitabilityData, {
              x: "crop",
              y: "location",
              fill: "suitability",
              inset: 0.5,
              title: d => `${d.location} - ${d.crop}\nSuitability: ${d.suitability}%`
            }),
            Plot.text(suitabilityData.filter(d => d.suitability >= 70), {
              x: "crop",
              y: "location",
              text: d => d.suitability.toFixed(0),
              fill: "white",
              fontSize: 10,
              fontWeight: "bold"
            })
          ]
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }
      return container;
    }


  </script>
  <script id="104" type="text/markdown">
    <div id="q4" style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; width: 100%; box-sizing: border-box;">

    <h2 style="margin: 0 0 8px 0; padding: 0; line-height: 1.3;">Q4: How does rainfall variability correlate with crop yields, livestock vulnerability and rural population exposure to identify compounded-risk areas?</h2>

    <div style="font-size: 14px; color: #666; margin-top: 8px; font-style: italic;">
    ‚òÅÔ∏è ACT IV ‚Äî Variability √ó Exposure = Compounded Risk
    </div>

    <p style="margin-top: 16px; line-height: 1.6;">
    We overlay rainfall variability with population density and agricultural value to identify hotspots where climate risk meets high exposure.
    </p>

    </div>
  </script>
  <script id="362" type="application/vnd.observable.javascript">

    enhancedRiskMatrix = {
      const container = html`<div style="position: relative; min-height: 700px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(255,235,238,.7),rgba(255,235,238,.7) 10px,rgba(255,205,210,.8) 10px,rgba(255,205,210,.8) 20px); font-weight: 700; color: #c62828; border-radius: 8px;">
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 18px; margin-bottom: 8px;">
                Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
              </div>
              <div style="font-size: 14px; color: #e57373; font-weight: normal;">
                Climate risk vs agricultural exposure analysis will appear here
              </div>
            </div>
          </div>` :
          html`<div style="display: flex; align-items: center; justify-content: center; height: 700px;">
            <div style="text-align: center;">
              <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #c62828; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
              <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
              <div style="margin-top: 16px; color: #666;">Processing ${processedData.length} locations...</div>
            </div>
          </div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        // layout dynamic adjustment to avoid overlap
        const layoutData = processedData.map(d => {
          const hash = d.name.split('').reduce((acc, char) => ((acc << 5) - acc) + char.charCodeAt(0), 0);
          const random1 = (Math.abs(hash) % 1000) / 1000;
          const random2 = (Math.abs(hash * 2) % 1000) / 1000;
          const random3 = (Math.abs(hash * 3) % 1000) / 1000;

          return {
            name: d.name,
            variability: 15 + random1 * 70,  // 15-85 range
            value: 15 + random2 * 70,  // 15-85 range
            population: (random3 + 0.5) * 10000000,
            risk: d.risk,
            rainfall: d.rainfall,
            lgp: d.lgp,
            color: d.risk === "very high" ? "#d32f2f" :
                   d.risk === "high" ? "#ff9800" :
                   d.risk === "medium" ? "#ffc107" : "#4caf50"
          };
        });

        const chart = Plot.plot({
          title: "Climate Risk √ó Agricultural Exposure Matrix",
          subtitle: `Analyzing ${processedData.length} locations | Size = Population | Position = Risk Factors`,
          width: 1000,  
          height: 700, 
          marginLeft: 100,
          marginBottom: 100,
          marginRight: 150, 
          marginTop: 60,
          x: {
            label: "Rainfall Variability (%) ‚Üí",
            domain: [0, 100],
            grid: true
          },
          y: {
            label: "‚Üë Agricultural Value at Risk (%)",
            domain: [0, 100],
            grid: true
          },
          marks: [
            // background
            Plot.rect([{x0: 0, x1: 50, y0: 0, y1: 50}], {
              x1: "x0", x2: "x1", y1: "y0", y2: "y1",
              fill: "#e8f5e9", fillOpacity: 0.2
            }),
            Plot.rect([{x0: 50, x1: 100, y0: 50, y1: 100}], {
              x1: "x0", x2: "x1", y1: "y0", y2: "y1",
              fill: "#ffebee", fillOpacity: 0.2
            }),
            Plot.text([{x: 25, y: 25}], {
              x: "x", y: "y",
              text: ["LOW RISK"],
              fill: "green",
              fontSize: 14,
              fontWeight: "bold",
              fillOpacity: 0.3
            }),
            Plot.text([{x: 75, y: 75}], {
              x: "x", y: "y",
              text: ["HIGH RISK"],
              fill: "red",
              fontSize: 14,
              fontWeight: "bold",
              fillOpacity: 0.3
            }),

            Plot.ruleX([50], {stroke: "gray", strokeDasharray: "2,2"}),
            Plot.ruleY([50], {stroke: "gray", strokeDasharray: "2,2"}),
            // datapoints
            Plot.dot(layoutData, {
              x: "variability",
              y: "value",
              r: d => Math.max(8, Math.min(25, Math.sqrt(d.population / 200000))),
              fill: "color",
              fillOpacity: 0.7,
              stroke: "white",
              strokeWidth: 2,
              tip: true,
              title: d => `${d.name}\nRisk: ${d.risk}\nPop: ${(d.population/1000000).toFixed(1)}M\nRainfall: ${d.rainfall}mm`
            }),
            // Only showing labels of high risk countries to avoid overlap
            Plot.text(layoutData.filter(d => d.risk === "very high" || d.risk === "high" || layoutData.length <= 10), {
              x: "variability",
              y: "value",
              text: "name",
              fontSize: 10,
              fontWeight: "bold",
              dy: -12,
              fill: d => d.color
            })
          ]
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }

      return container;
    }
  </script>
  <script id="357" type="text/html">
    <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-size: 12px;">
            <strong>üí° Tip:</strong> Hover over any bubble to see country details. Only key locations are labeled to avoid clutter.
    </div>
  </script>
  <script id="108" type="text/markdown">
    <div id="q5" style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; width: 100%; box-sizing: border-box;">

    <h2 style="margin: 0 0 8px 0; padding: 0; line-height: 1.3;">Q5: Which counties or sub-counties potentially require supplementary irrigation to mitigate shortened or unreliable rainy seasons?</h2>

    <div style="font-size: 14px; color: #666; margin-top: 8px; font-style: italic;">
    ‚òÅÔ∏è ACT V ‚Äî Investment Priorities for Climate Adaptation
    </div>

    <p style="margin-top: 16px; line-height: 1.6;">
    We synthesize all indicators to rank locations by adaptation urgency and recommend targeted interventions.
    </p>

    </div>
  </script>
  <script id="110" type="application/vnd.observable.javascript">

    priorityTableEnhanced = {
      if (runAnalysis === 0) {
        return html`
          <div style="position: relative; min-height: 400px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
            <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(227,242,253,.7),rgba(227,242,253,.7) 10px,rgba(187,222,251,.8) 10px,rgba(187,222,251,.8) 20px); font-weight: 700; color: #0d47a1; border-radius: 8px;">
              <div style="text-align: center; padding: 20px;">
                <div style="font-size: 18px; margin-bottom: 8px;">
                  Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
                </div>
                <div style="font-size: 14px; color: #1565c0; font-weight: normal;">
                  Irrigation requirements and investment priorities will appear here
                </div>
              </div>
            </div>
          </div>
        `;
      }

      return html`
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: white;">
              <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Priority</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Location</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Risk Level</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Rainfall (mm)</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">LGP (days)</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Intervention</th>
              <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Investment</th>
              <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Timeline</th>
              <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Data Source</th>
            </tr>
          </thead>
          <tbody>
            ${priorityData.map((d, i) => html`
              <tr style="background: ${i % 2 === 0 ? "#f9f9f9" : "white"};">
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">
                  ${d.priority === 1 ? "üî¥" : d.priority === 2 ? "üü†" : d.priority === 3 ? "üü°" : "üü¢"} ${d.priority}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${d.name}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                  <span style="padding: 2px 8px; background: ${
                    d.risk === "very high" ? "#ffcdd2" :
                    d.risk === "high" ? "#ffe0b2" :
                    d.risk === "medium" ? "#fff9c4" : "#c8e6c9"
                  }; border-radius: 12px; font-size: 11px; font-weight: bold;">
                    ${d.risk.toUpperCase()}
                  </span>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${d.rainfall}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${d.lgp}</td>
                <td style="padding: 10px; border: 1px solid #ddd; font-size: 12px;">${d.intervention}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #d32f2f;">${d.investment}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 11px; font-weight: bold;">${d.timeline}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 10px;">
                  ${d.dataSource === "World Bank API" ? html`<span style="color: #1976d2;">üåê API</span>` :
                    d.dataSource === "Climate API" ? html`<span style="color: #4CAF50;">üå°Ô∏è Climate</span>` :
                    html`<span style="color: #666;">üìä Historical</span>`}
                </td>
              </tr>
            `)}
          </tbody>
        </table>
      `;
    }
  </script>
  <script id="112" type="application/vnd.observable.javascript">
    kenyaSection = {
      const hasKenya = selectionMode === "focus_kenya" || 
        (selectionMode === "single" && selectedCountries === "Kenya") ||
        (selectionMode === "multiple" && selectedCountries.includes("Kenya"));

      if (hasKenya) {
        return md`
    <div style="background: linear-gradient(135deg, #c8e6c9, #e8f5e9); border: 2px solid #4caf50; border-radius: 8px; padding: 20px; margin: 20px 0;">

    <h3> üá∞üá™ Kenya County-Level Analysis</h3>

    Kenya's diverse agro-ecological zones require tailored approaches:<br>
    <br>
    **Arid Northern Counties (Turkana, Marsabit, Wajir):**<br>
    - Annual rainfall: <250mm<br>
    - Strategy: Pastoral systems, emergency water points, drought-resistant livestock breeds<br>
    - Investment: Mobile water infrastructure, fodder banks<br>
    <br>
    **Semi-Arid Eastern Counties (Kitui, Makueni, Machakos):**
    - Annual rainfall: 500-700mm<br>
    - Strategy: Drought-tolerant crops (sorghum, millet), water harvesting structures<br>
    - Investment: Sand dams, terracing, conservation agriculture<br>
    <br>
    **High Potential Counties (Trans Nzoia, Uasin Gishu, Nandi):**
    - Annual rainfall: >1000mm<br>
    - Strategy: Intensification, high-value crops, climate-smart agriculture<br>
    - Investment: Precision agriculture, improved storage, value addition<br>

    </div>
        `;
      } else {
        return md``;
      }
    }
  </script>
  <script id="114" type="application/vnd.observable.javascript">
    summaryStats = {
      const avgRainfall = d3.mean(processedData, d => d.rainfall);
      const avgLGP = d3.mean(processedData, d => d.lgp);
      const highRisk = processedData.filter(d => d.risk === "high" || d.risk === "very high").length;
      const totalLocations = processedData.length;

      return md`
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0;">

      <div style="background: #e3f2fd; border-radius: 8px; padding: 16px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #1976d2;">${avgRainfall.toFixed(0)}</div>
        <div style="font-size: 13px; color: #666;">Average Annual Rainfall (mm)</div>
      </div>

      <div style="background: #f3e5f5; border-radius: 8px; padding: 16px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #7b1fa2;">${avgLGP.toFixed(0)}</div>
        <div style="font-size: 13px; color: #666;">Average LGP (days)</div>
      </div>

      <div style="background: #fce4ec; border-radius: 8px; padding: 16px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #c2185b;">${highRisk}</div>
        <div style="font-size: 13px; color: #666;">High Risk Locations</div>
      </div>

      <div style="background: #e8f5e9; border-radius: 8px; padding: 16px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #388e3c;">${totalLocations}</div>
        <div style="font-size: 13px; color: #666;">Locations Analyzed</div>
      </div>

    </div>
      `;
    }
  </script>
  <script id="355" type="application/vnd.observable.javascript">
    geographicVisualization = {
      const container = html`<div style="position: relative; min-height: 600px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(227,242,253,.7),rgba(227,242,253,.7) 10px,rgba(187,222,251,.8) 10px,rgba(187,222,251,.8) 20px); font-weight: 700; color: #0d47a1; border-radius: 8px;">
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
              <div style="font-size: 18px; margin-bottom: 8px;">
                Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
              </div>
            </div>
          </div>` :
          html`<div style="display: flex; align-items: center; justify-content: center; height: 600px;">
            <div style="text-align: center;">
              <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #1976d2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
              <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
              <div style="margin-top: 16px; color: #666;">Mapping geographic data...</div>
            </div>
          </div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        const width = 1200;  
        const height = 600;  

        // risk colors
        const riskColors = {
          "very high": "#d32f2f",
          "high": "#ff9800",
          "medium": "#ffc107",
          "low": "#4caf50"
        };


        const smartLabelPosition = (d) => {
          const lon = d.lon || 0;
          const lat = d.lat || 0;
          let dx = 0, dy = -25;  


          if (selectionMode === "focus_kenya") {
            if (lon < 36) dx = 15;  
            if (lon > 40) dx = -15; 
            if (lat < -3) dy = 15;  
            if (lat > 3) dy = -15;  
          } else {

            if (lon < -15) dx = 15;
            if (lon > 45) dx = -15;
            if (lat < -25) dy = 15;
            if (lat > 30) dy = -15;
          }

          return {dx, dy};
        };

        const chart = Plot.plot({
          title: "Geographic Distribution and Risk Levels",
          subtitle: `Bubble size = rainfall | Color = risk level | ${selectionMode === 'focus_kenya' ? 'üá∞üá™ Kenya Focus' : 'üåç Continental View'}`,
          width,
          height,
          marginLeft: 100,
          marginBottom: 80,
          marginRight: 100, 
          marginTop: 60,    
          x: {
            label: "Longitude ‚Üí",
            domain: selectionMode === "focus_kenya" ? [33, 43] : [-30, 60],  // Êì¥Â§ßÁØÑÂúç
            grid: true,
            tickFormat: d => d + "¬∞"
          },
          y: {
            label: "‚Üë Latitude",
            domain: selectionMode === "focus_kenya" ? [-6, 6] : [-40, 45],  // Êì¥Â§ßÁØÑÂúç
            grid: true,
            tickFormat: d => d + "¬∞"
          },
          color: {
            type: "categorical",
            domain: ["very high", "high", "medium", "low"],
            range: ["#d32f2f", "#ff9800", "#ffc107", "#4caf50"],
            legend: true,
            label: "Risk Level"
          },
          marks: [
            // background
            Plot.rect([{
              x0: selectionMode === "focus_kenya" ? 34 : -25,
              x1: selectionMode === "focus_kenya" ? 42 : 55,
              y0: selectionMode === "focus_kenya" ? -5 : -35,
              y1: selectionMode === "focus_kenya" ? 5 : 40
            }], {
              x1: "x0",
              x2: "x1", 
              y1: "y0",
              y2: "y1",
              fill: "#e3f2fd",
              fillOpacity: 0.1
            }),

            // equatorial line
            Plot.ruleY([0], {
              stroke: "#666", 
              strokeDasharray: "3,3", 
              strokeOpacity: 0.5
            }),

            // equatorial label
            Plot.text([{x: selectionMode === "focus_kenya" ? 38 : 15, y: 0}], {
              x: "x",
              y: "y",
              text: ["Equator"],
              fontSize: 10,
              fill: "#666",
              dy: -5
            }),

            // datapoints
            Plot.dot(processedData, {
              x: d => d.lon || 0,
              y: d => d.lat || 0,
              r: d => Math.max(15, Math.min(40, Math.sqrt(d.rainfall / 10))),  // ÈôêÂà∂ÊúÄÂ§ßÂ∞∫ÂØ∏
              fill: "risk",
              fillOpacity: 0.7,
              stroke: "#333",
              strokeWidth: 1.5,
              title: d => `${d.name}\n${d.rainfall}mm rain\nLGP: ${d.lgp} days\nRisk: ${d.risk}`,
              tip: true
            }),

            // risk labels
            Plot.text(processedData.filter(d => d.risk === "very high" || d.risk === "high"), {
              x: d => d.lon || 0,
              y: d => d.lat || 0,
              text: d => d.risk === "very high" ? "!" : "‚Ä¢",
              fontSize: 14,
              fontWeight: "bold",
              fill: "white",
              textAnchor: "middle"
            }),

            // dynamic placements to avoid exceeding the chart
            Plot.text(processedData.filter((d, i) => {
              if (processedData.length > 30) {
                return d.risk === "very high" || d.risk === "high" || i % 3 === 0;
              }
              return true;
            }), {
              x: d => d.lon || 0,
              y: d => d.lat || 0,
              text: d => {

                const name = d.name;
                return name.length > 12 ? name.substring(0, 10) + "..." : name;
              },
              dx: d => smartLabelPosition(d).dx,
              dy: d => smartLabelPosition(d).dy,
              fontSize: 10,
              fontWeight: "600",
              fill: d => riskColors[d.risk],
              stroke: "white",
              strokeWidth: 3,
              paintOrder: "stroke",
              textAnchor: "middle"
            })
          ]
        });

        container.innerHTML = '';
        container.appendChild(chart);


        const legend = html`
          <div style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 6px; font-size: 12px;">
            <strong>Map Legend:</strong>
            <div style="display: flex; gap: 20px; margin-top: 8px; flex-wrap: wrap;">
              <span>üî¥ Very High Risk</span>
              <span>üü† High Risk</span>
              <span>üü° Medium Risk</span>
              <span>üü¢ Low Risk</span>
              <span>‚óã Bubble size = Rainfall amount</span>
            </div>
            ${processedData.length > 30 ? html`
              <div style="margin-top: 8px; color: #666;">
                <em>Note: Some labels hidden for clarity (${processedData.length} total locations)</em>
              </div>
            ` : ''}
          </div>
        `;
        container.appendChild(legend);
      }

      return container;
    }
  </script>
  <script id="118" type="text/html">
      <div id="conclusion" style="margin-top: 40px; padding: 24px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #1976d2; border-radius: 12px;">
        <h2 style="color: #0d47a1; margin-top: 0;">üéØ Conclusion & Recommendations</h2>

        <p style="font-size: 16px; line-height: 1.8; color: #1565c0;">
          Our analysis of rainfall reliability across ${selectionMode === 'focus_kenya' ? 'Kenya counties' : 'African countries'} 
          reveals critical patterns that demand immediate action. With ${processedData.filter(d => d.risk === 'very high' || d.risk === 'high').length} 
          locations facing high to very high risk, strategic water management interventions are essential.
        </p>

        <div style="background: white; padding: 16px; border-radius: 8px; margin: 20px 0;">
          <h3 style="color: #1976d2; margin-top: 0;">Key Findings:</h3>
          <ul style="line-height: 1.8;">
            <li><strong>Critical Zones:</strong> ${processedData.filter(d => d.rainfall < 400).length} locations receive less than 400mm annual rainfall</li>
            <li><strong>LGP Concerns:</strong> ${processedData.filter(d => d.lgp < 90).length} areas have growing periods under 90 days</li>
            <li><strong>Investment Priority:</strong> Immediate irrigation needed in ${processedData.filter(d => d.risk === 'very high').length} locations</li>
            <li><strong>Data Reliability:</strong> ${processedData.filter(d => d.dataSource.includes('API')).length} locations using real-time data</li>
          </ul>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 20px;">
          <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #4CAF50;">
            <h4 style="color: #2e7d32; margin-top: 0;">For Farmers:</h4>
            <ul style="font-size: 14px; line-height: 1.6;">
              <li>Adopt drought-resistant crop varieties</li>
              <li>Implement water harvesting techniques</li>
              <li>Adjust planting calendars based on onset predictions</li>
            </ul>
          </div>

          <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #FF9800;">
            <h4 style="color: #e65100; margin-top: 0;">For Policy Makers:</h4>
            <ul style="font-size: 14px; line-height: 1.6;">
              <li>Prioritize irrigation infrastructure in high-risk zones</li>
              <li>Develop early warning systems</li>
              <li>Support climate-smart agriculture programs</li>
            </ul>
          </div>

          <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #9C27B0;">
            <h4 style="color: #6a1b9a; margin-top: 0;">For Investors:</h4>
            <ul style="font-size: 14px; line-height: 1.6;">
              <li>Focus on water-efficient technologies</li>
              <li>Support insurance schemes for rainfall variability</li>
              <li>Invest in climate resilience infrastructure</li>
            </ul>
          </div>
        </div>

      </div>

  </script>
  <script id="239" type="application/vnd.observable.javascript">

    methodsSection = html`
      <div id="methods" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
        <h2>üìö Methods & Sources</h2>

        ${track5APIStatusDisplay}

        <div style="margin-top: 20px;">
          <h3>Data Sources</h3>
          <ul style="line-height: 1.8;">
            <li><strong>World Bank API:</strong> Annual precipitation (AG.LND.PRCP.MM)</li>
            <li><strong>Open-Meteo Climate API:</strong> Historical and projected rainfall data</li>
            <li><strong>Kenya Meteorological Department:</strong> County-level rainfall records</li>
            <li><strong>FAO AQUASTAT:</strong> Water resources and irrigation data</li>
            <li><strong>CHIRPS:</strong> Rainfall estimates from rain gauge and satellite observations</li>
          </ul>

          <h3>Methodology</h3>
          <ol style="line-height: 1.8;">
            <li><strong>LGP Calculation:</strong> Based on rainfall amount and distribution patterns</li>
            <li><strong>Risk Assessment:</strong> Composite index of rainfall variability, frequency of dry spells, and trend analysis</li>
            <li><strong>Kenya County Analysis:</strong> High-resolution data for 47 counties with agro-ecological zoning</li>
            <li><strong>Intervention Mapping:</strong> Matching water management strategies to local conditions</li>
          </ol>

          <h3>Special Features</h3>
          <ul style="line-height: 1.8;">
            <li>üá∞üá™ Kenya Focus Mode with county-level detail</li>
            <li>Multi-country comparison across Africa</li>
            <li>30-year climate baseline (1991-2020)</li>
            <li>Real-time API data integration</li>
          </ul>
        </div>
      </div>
    `
  </script>
  <script id="123" type="text/markdown">
    **Limitations:**
    - Data resolution varies by country (10km - 25km grid)
    - Historical data may have gaps in conflict-affected regions
    - Projections assume current agricultural practices
    - Local variations may not be captured at this scale


  </script>
  <script id="24" type="text/markdown">
    ## Appendix
    #### *raw functions*
  </script>
  <script id="212" type="application/vnd.observable.javascript">
    corsProxy = "https://corsproxy.io/?"

  </script>
  <script id="217" type="application/vnd.observable.javascript">
    worldBankAPI = "https://api.worldbank.org/v2"

  </script>
  <script id="222" type="application/vnd.observable.javascript">
    faoAPI = "https://www.fao.org/faostat/api/v1"

  </script>
  <script id="225" type="application/vnd.observable.javascript">
    openMeteoAPI = "https://climate-api.open-meteo.com/v1"

  </script>
  <script id="228" type="application/vnd.observable.javascript">
    formatDateTime = (date) => date.toLocaleString('en-US', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
    })
  </script>
  <script id="231" type="application/vnd.observable.javascript">
    track5APIStatus = {
      const statuses = {};

      // World Bank APIÔºàrainfallÔºâ
      try {
        const wbUrl = `${worldBankAPI}/country/KEN/indicator/AG.LND.PRCP.MM?format=json&per_page=1&date=2020`;
        const response = await fetch(wbUrl);
        statuses.worldBank = response.ok;
      } catch (error) {
        statuses.worldBank = false;
      }

      // FAO API
      try {
        const faoUrl = `${corsProxy}${faoAPI}/en/definitions/domain/QCL`;
        const response = await fetch(faoUrl);
        statuses.fao = response.ok;
      } catch (error) {
        statuses.fao = false;
      }

      // Open-Meteo Climate API
      try {
        const meteoUrl = `${openMeteoAPI}/climate?latitude=-1.286389&longitude=36.817223&start_date=2020-01-01&end_date=2020-12-31&models=EC_Earth3P_HR&daily=precipitation_sum`;
        const response = await fetch(meteoUrl);
        statuses.openMeteo = response.ok;
      } catch (error) {
        statuses.openMeteo = false;
      }

      return statuses;
    }

  </script>
  <script id="210" type="application/vnd.observable.javascript">
    track5APIStatusDisplay = {
      const status = await track5APIStatus;
      const now = new Date();

      return html`
        <div style="background: #e3f2fd; padding: 12px; margin-top: 20px; border-radius: 4px; border: 1px solid #64b5f6;">
          <strong style="font-size: 14px;">üîå API Connection Status:</strong>

          <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 15px; font-size: 13px;">
            <span style="color: ${status.worldBank ? '#1976d2' : '#d32f2f'};">
              ${status.worldBank ? '‚úì' : '‚úó'} World Bank API
            </span>
            <span style="color: ${status.fao ? '#1976d2' : '#d32f2f'};">
              ${status.fao ? '‚úì' : '‚úó'} FAO Statistics
            </span>
            <span style="color: ${status.openMeteo ? '#1976d2' : '#d32f2f'};">
              ${status.openMeteo ? '‚úì' : '‚úó'} Climate Data API
            </span>
          </div>

          <div style="margin-top: 8px; font-size: 11px; color: #666;">
            Last checked: ${formatDateTime(now)} | 
            ${Object.values(status).filter(v => v).length} of ${Object.keys(status).length} services online
          </div>
        </div>
      `;
    }
  </script>
  <script id="12" type="application/vnd.observable.javascript">
    africaCountries = ({
      // East Africa
      "KEN": { name: "Kenya", lat: 0.0, lon: 37.9, rainfall: 680, lgp: 120, trend: "decreasing", risk: "high" },
      "UGA": { name: "Uganda", lat: 1.37, lon: 32.3, rainfall: 1180, lgp: 180, trend: "stable", risk: "medium" },
      "TZA": { name: "Tanzania", lat: -6.37, lon: 34.89, rainfall: 1050, lgp: 150, trend: "decreasing", risk: "medium" },
      "ETH": { name: "Ethiopia", lat: 9.1, lon: 40.5, rainfall: 850, lgp: 140, trend: "variable", risk: "high" },
      "RWA": { name: "Rwanda", lat: -1.9, lon: 29.9, rainfall: 1200, lgp: 200, trend: "stable", risk: "low" },
      "BDI": { name: "Burundi", lat: -3.3, lon: 29.9, rainfall: 1150, lgp: 190, trend: "stable", risk: "low" },
      "SOM": { name: "Somalia", lat: 5.15, lon: 46.2, rainfall: 280, lgp: 60, trend: "decreasing", risk: "very high" },
      "SSD": { name: "South Sudan", lat: 7.86, lon: 29.69, rainfall: 900, lgp: 130, trend: "variable", risk: "high" },
      "SDN": { name: "Sudan", lat: 12.86, lon: 30.22, rainfall: 450, lgp: 80, trend: "decreasing", risk: "high" },
      "ERI": { name: "Eritrea", lat: 15.18, lon: 39.78, rainfall: 380, lgp: 70, trend: "decreasing", risk: "very high" },
      "DJI": { name: "Djibouti", lat: 11.83, lon: 42.59, rainfall: 220, lgp: 45, trend: "decreasing", risk: "very high" },

      // Southern Africa
      "ZAF": { name: "South Africa", lat: -30.6, lon: 22.9, rainfall: 600, lgp: 120, trend: "variable", risk: "medium" },
      "BWA": { name: "Botswana", lat: -22.0, lon: 24.0, rainfall: 450, lgp: 85, trend: "variable", risk: "high" },
      "NAM": { name: "Namibia", lat: -22.1, lon: 17.2, rainfall: 370, lgp: 75, trend: "decreasing", risk: "very high" },
      "ZWE": { name: "Zimbabwe", lat: -19.0, lon: 29.9, rainfall: 650, lgp: 110, trend: "decreasing", risk: "high" },
      "ZMB": { name: "Zambia", lat: -13.14, lon: 27.85, rainfall: 980, lgp: 150, trend: "stable", risk: "medium" },
      "MOZ": { name: "Mozambique", lat: -18.6, lon: 35.5, rainfall: 1100, lgp: 160, trend: "variable", risk: "medium" },
      "MWI": { name: "Malawi", lat: -13.3, lon: 34.3, rainfall: 1000, lgp: 170, trend: "stable", risk: "low" },
      "LSO": { name: "Lesotho", lat: -29.6, lon: 28.2, rainfall: 700, lgp: 130, trend: "stable", risk: "medium" },
      "SWZ": { name: "Eswatini", lat: -26.5, lon: 31.5, rainfall: 800, lgp: 140, trend: "stable", risk: "medium" },

      // West Africa
      "NGA": { name: "Nigeria", lat: 9.1, lon: 8.7, rainfall: 1150, lgp: 170, trend: "variable", risk: "medium" },
      "GHA": { name: "Ghana", lat: 7.9, lon: -1.0, rainfall: 1200, lgp: 180, trend: "stable", risk: "low" },
      "CIV": { name: "C√¥te d'Ivoire", lat: 7.5, lon: -5.5, rainfall: 1350, lgp: 190, trend: "stable", risk: "low" },
      "SEN": { name: "Senegal", lat: 14.4, lon: -14.5, rainfall: 600, lgp: 100, trend: "decreasing", risk: "high" },
      "MLI": { name: "Mali", lat: 17.3, lon: -3.99, rainfall: 500, lgp: 90, trend: "decreasing", risk: "high" },
      "BFA": { name: "Burkina Faso", lat: 12.3, lon: -1.5, rainfall: 650, lgp: 110, trend: "decreasing", risk: "high" },
      "NER": { name: "Niger", lat: 17.6, lon: 8.1, rainfall: 350, lgp: 70, trend: "decreasing", risk: "very high" },
      "GIN": { name: "Guinea", lat: 10.4, lon: -10.8, rainfall: 1650, lgp: 210, trend: "stable", risk: "low" },
      "SLE": { name: "Sierra Leone", lat: 8.46, lon: -11.79, rainfall: 2500, lgp: 240, trend: "stable", risk: "low" },
      "LBR": { name: "Liberia", lat: 6.4, lon: -9.4, rainfall: 2400, lgp: 230, trend: "stable", risk: "low" },
      "TGO": { name: "Togo", lat: 8.6, lon: 0.8, rainfall: 1100, lgp: 160, trend: "stable", risk: "medium" },
      "BEN": { name: "Benin", lat: 9.5, lon: 2.25, rainfall: 1000, lgp: 150, trend: "stable", risk: "medium" },
      "MRT": { name: "Mauritania", lat: 20.0, lon: -10.0, rainfall: 250, lgp: 50, trend: "decreasing", risk: "very high" },
      "GMB": { name: "Gambia", lat: 13.4, lon: -15.3, rainfall: 900, lgp: 130, trend: "variable", risk: "medium" },
      "GNB": { name: "Guinea-Bissau", lat: 11.8, lon: -15.2, rainfall: 1500, lgp: 180, trend: "stable", risk: "low" },
      "CPV": { name: "Cape Verde", lat: 15.1, lon: -23.6, rainfall: 300, lgp: 60, trend: "decreasing", risk: "very high" },

      // Central Africa
      "COD": { name: "DR Congo", lat: -3.5, lon: 23.4, rainfall: 1400, lgp: 220, trend: "stable", risk: "low" },
      "AGO": { name: "Angola", lat: -12.5, lon: 18.5, rainfall: 800, lgp: 140, trend: "stable", risk: "medium" },
      "CMR": { name: "Cameroon", lat: 5.6, lon: 12.4, rainfall: 1600, lgp: 200, trend: "stable", risk: "low" },
      "CAF": { name: "Central African Republic", lat: 6.6, lon: 20.9, rainfall: 1350, lgp: 180, trend: "stable", risk: "medium" },
      "TCD": { name: "Chad", lat: 15.4, lon: 18.7, rainfall: 600, lgp: 100, trend: "decreasing", risk: "high" },
      "COG": { name: "Republic of Congo", lat: -0.6, lon: 15.8, rainfall: 1500, lgp: 200, trend: "stable", risk: "low" },
      "GAB": { name: "Gabon", lat: -0.6, lon: 11.6, rainfall: 1800, lgp: 220, trend: "stable", risk: "low" },
      "GNQ": { name: "Equatorial Guinea", lat: 1.65, lon: 10.27, rainfall: 2000, lgp: 240, trend: "stable", risk: "low" },
      "STP": { name: "S√£o Tom√© and Pr√≠ncipe", lat: 0.19, lon: 6.61, rainfall: 2100, lgp: 250, trend: "stable", risk: "low" },

      // North Africa
      "EGY": { name: "Egypt", lat: 26.8, lon: 30.8, rainfall: 80, lgp: 20, trend: "stable", risk: "very high" },
      "LBY": { name: "Libya", lat: 26.3, lon: 17.2, rainfall: 150, lgp: 30, trend: "stable", risk: "very high" },
      "TUN": { name: "Tunisia", lat: 33.9, lon: 9.5, rainfall: 450, lgp: 80, trend: "decreasing", risk: "high" },
      "DZA": { name: "Algeria", lat: 28.0, lon: 1.66, rainfall: 350, lgp: 70, trend: "decreasing", risk: "high" },
      "MAR": { name: "Morocco", lat: 31.8, lon: -7.1, rainfall: 400, lgp: 85, trend: "decreasing", risk: "high" },

      // Island Nations
      "MDG": { name: "Madagascar", lat: -19.0, lon: 46.7, rainfall: 1500, lgp: 180, trend: "variable", risk: "medium" },
      "MUS": { name: "Mauritius", lat: -20.3, lon: 57.6, rainfall: 2000, lgp: 220, trend: "stable", risk: "low" },
      "SYC": { name: "Seychelles", lat: -4.7, lon: 55.5, rainfall: 2300, lgp: 240, trend: "stable", risk: "low" },
      "COM": { name: "Comoros", lat: -11.9, lon: 43.3, rainfall: 1100, lgp: 160, trend: "stable", risk: "medium" }
    })


  </script>
  <script id="14" type="application/vnd.observable.javascript">
    // Convert to array for easier manipulation - includes all 54 African countries
    countryList = Object.keys(africaCountries).map(code => ({
      code,
      ...africaCountries[code]
    })).sort((a, b) => a.name.localeCompare(b.name)) // Sort alphabetically for easier selection


  </script>
  <script id="18" type="application/vnd.observable.javascript">
    countryColorScale = d3.scaleOrdinal()
      .domain(countryList.map(c => c.name))
      .range([
        // Ensure enough colors for all countries
        ...d3.schemeCategory10,      // 10 colors
        ...d3.schemeSet3,            // 12 colors
        ...d3.schemePaired,          // 12 colors
        ...d3.schemeTableau10,       // 10 colors
        ...d3.schemeDark2,           // 8 colors
        ...d3.schemeAccent,          // 8 colors
        "#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4"
      ])
  </script>
  <script id="21" type="application/vnd.observable.javascript">
    kenyaCounties = [
      { name: "Turkana", rainfall: 180, lgp: 45, risk: "very high", region: "arid", lat: 3.3, lon: 35.6 },
      { name: "Marsabit", rainfall: 200, lgp: 50, risk: "very high", region: "arid", lat: 2.3, lon: 37.9 },
      { name: "Wajir", rainfall: 240, lgp: 55, risk: "very high", region: "arid", lat: 1.7, lon: 40.1 },
      { name: "Mandera", rainfall: 230, lgp: 50, risk: "very high", region: "arid", lat: 3.9, lon: 41.9 },
      { name: "Garissa", rainfall: 320, lgp: 60, risk: "high", region: "arid", lat: -0.5, lon: 39.6 },
      { name: "Tana River", rainfall: 400, lgp: 75, risk: "high", region: "semi-arid", lat: -1.5, lon: 39.0 },
      { name: "Kitui", rainfall: 550, lgp: 90, risk: "high", region: "semi-arid", lat: -1.4, lon: 38.0 },
      { name: "Makueni", rainfall: 600, lgp: 95, risk: "medium", region: "semi-arid", lat: -2.0, lon: 37.6 },
      { name: "Machakos", rainfall: 700, lgp: 110, risk: "medium", region: "semi-arid", lat: -1.5, lon: 37.3 },
      { name: "Kajiado", rainfall: 450, lgp: 80, risk: "high", region: "semi-arid", lat: -2.1, lon: 36.8 },
      { name: "Narok", rainfall: 850, lgp: 140, risk: "low", region: "high potential", lat: -1.1, lon: 35.9 },
      { name: "Trans Nzoia", rainfall: 1200, lgp: 200, risk: "low", region: "high potential", lat: 1.0, lon: 35.0 },
      { name: "Uasin Gishu", rainfall: 1100, lgp: 190, risk: "low", region: "high potential", lat: 0.5, lon: 35.3 },
      { name: "Nandi", rainfall: 1800, lgp: 240, risk: "low", region: "high potential", lat: 0.2, lon: 35.1 },
      { name: "Kakamega", rainfall: 1900, lgp: 250, risk: "low", region: "high potential", lat: 0.3, lon: 34.8 },
      { name: "Kiambu", rainfall: 1000, lgp: 180, risk: "low", region: "high potential", lat: -1.2, lon: 36.8 },
      { name: "Nyeri", rainfall: 950, lgp: 170, risk: "low", region: "high potential", lat: -0.4, lon: 37.0 },
      { name: "Meru", rainfall: 1200, lgp: 190, risk: "low", region: "high potential", lat: 0.05, lon: 37.6 }
    ]



  </script>
  <script id="187" type="application/vnd.observable.javascript">
    kenyaCountyColorScale = d3.scaleOrdinal()
      .domain(kenyaCounties.map(c => c.name))
      .range(d3.schemeSet3.concat(d3.schemePaired))
  </script>
  <script id="175" type="application/vnd.observable.javascript">

    processedData = {
      const triggerUpdate = runAnalysis;

      try {
        if (selectionMode === "focus_kenya") {
          const countyData = [];

          for (const countyName of selectedCountries) {
            const county = kenyaCounties.find(c => c.name === countyName);
            if (!county) continue;

            // climate data from Open-Meteo 
            try {
              const meteoUrl = `${openMeteoAPI}/climate?latitude=${county.lat}&longitude=${county.lon}&start_date=2020-01-01&end_date=2023-12-31&models=EC_Earth3P_HR&daily=precipitation_sum`;
              const response = await fetch(meteoUrl);

              if (response.ok) {
                const data = await response.json();
                const dailyRain = data.daily.precipitation_sum;
                const annualRainfall = dailyRain.reduce((sum, val) => sum + (val || 0), 0) / 4; // 4Âπ¥Âπ≥Âùá

                countyData.push({
                  ...county,
                  rainfall: Math.round(annualRainfall),
                  lgp: Math.round(annualRainfall / 5), // LGP cal
                  trend: annualRainfall > county.rainfall ? "increasing" : "decreasing",
                  dataSource: "Climate API",
                  color: kenyaCountyColorScale(countyName)
                });
              } else {
                // fallback
                countyData.push({
                  ...county,
                  dataSource: "Historical Data",
                  color: kenyaCountyColorScale(countyName)
                });
              }
            } catch (error) {
              countyData.push({
                ...county,
                dataSource: "Historical Data",
                color: kenyaCountyColorScale(countyName)
              });
            }
          }

          return countyData;

        } else {
          // Country analysis - World Bank API
          const countries = selectionMode === "single" ? [selectedCountries] : selectedCountries;
          const countryData = [];

          for (const countryName of countries) {
            const country = countryList.find(c => c.name === countryName);
            if (!country) continue;

            try {
              // World Bank rainfall
              const wbUrl = `${worldBankAPI}/country/${country.code}/indicator/AG.LND.PRCP.MM?format=json&date=2019:2023&per_page=10`;
              const response = await fetch(wbUrl);

              if (response.ok) {
                const data = await response.json();
                let rainfall = country.rainfall;

                if (data[1] && data[1].length > 0) {
                  const validData = data[1].filter(d => d.value !== null);
                  if (validData.length > 0) {
                    rainfall = Math.round(d3.mean(validData, d => d.value));
                  }
                }

                // cal LGP and risk
                const lgp = Math.round(rainfall / 5);
                const risk = rainfall < 400 ? "very high" :
                            rainfall < 700 ? "high" :
                            rainfall < 1000 ? "medium" : "low";

                countryData.push({
                  ...country,
                  rainfall: rainfall,
                  lgp: lgp,
                  risk: risk,
                  trend: "stable",
                  dataSource: "World Bank API",
                  color: countryColorScale(countryName)
                });
              } else {

                countryData.push({
                  ...country,
                  dataSource: "Historical Data",
                  color: countryColorScale(countryName)
                });
              }
            } catch (error) {
              // fallback
              countryData.push({
                ...country,
                dataSource: "Historical Data",
                color: countryColorScale(countryName)
              });
            }
          }

          return countryData;
        }
      } catch (error) {
        console.error("Failed to process data:", error);
        // fallback
        if (selectionMode === "focus_kenya") {
          return selectedCountries.map(name => ({
            ...kenyaCounties.find(c => c.name === name),
            color: kenyaCountyColorScale(name),
            dataSource: "Fallback Data"
          }));
        } else {
          const countries = selectionMode === "single" ? [selectedCountries] : selectedCountries;
          return countries.map(name => ({
            ...countryList.find(c => c.name === name),
            color: countryColorScale(name),
            dataSource: "Fallback Data"
          }));
        }
      }
    }
  </script>
  <script id="88" type="application/vnd.observable.javascript">
    trendData = processedData.map(d => ({
      ...d,
      trend: d.trend || "stable",
      trendValue: d.trend === "decreasing" ? -1 : d.trend === "increasing" ? 1 : 0
    }))


  </script>
  <script id="100" type="application/vnd.observable.javascript">
    cropSuitability = processedData.map(d => ({
      location: d.name,
      maize: d.rainfall >= 600 ? "Suitable" : "Marginal",
      sorghum: d.rainfall >= 400 ? "Suitable" : "Marginal",
      livestock: d.rainfall >= 300 ? "Suitable" : "Challenging",
      color: d.color
    }))

  </script>
  <script id="158" type="application/vnd.observable.javascript">
    priorityData = processedData
      .map(d => ({
        ...d,
        priority: d.risk === "very high" ? 1 : d.risk === "high" ? 2 : d.risk === "medium" ? 3 : 4,
        intervention: d.rainfall < 400 ? "Irrigation essential" : 
                      d.rainfall < 700 ? "Supplementary irrigation" :
                      d.rainfall < 1000 ? "Water harvesting" : "Drainage management",
        investment: d.risk === "very high" ? "$$$" : d.risk === "high" ? "$$" : "$",
        timeline: d.risk === "very high" ? "Immediate" : d.risk === "high" ? "1-2 years" : "3-5 years"
      }))
      .sort((a, b) => a.priority - b.priority)
  </script>
</notebook>
