<!doctype html>
<notebook theme="air">
  <title>üí°Track 4 ‚Äî Climate &amp; Health Explorer: Uncovering the Climate‚ÄìInfectious Disease Nexus</title>
  <script id="120" type="text/markdown">
    # üí°Track 4 ‚Äî Climate & Health Explorer: Uncovering the Climate‚ÄìInfectious Disease Nexus

  </script>
  <script id="0" type="text/markdown">
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
      <span style="padding: 4px 12px; background: #e8f0ff; border: 1px solid #0b5fff; border-radius: 16px; font-size: 12px; color: #0b5fff;">Interactive Explorer</span>
      <span style="padding: 4px 12px; background: #e8f5e9; border: 1px solid #10b981; border-radius: 16px; font-size: 12px; color: #10b981;">Decision Support Tool</span>
      <span style="padding: 4px 12px; background: #fff2b3; border: 1px solid #f59e0b; border-radius: 16px; font-size: 12px; color: #f59e0b;">All Africa Coverage</span>
    </div>
  </script>
  <script id="124" type="text/html">
    <nav style="padding: 10px 12px; border: 1px dashed #bbb; border-radius: 6px; background: #fff; margin-bottom: 16px; font-size: 14px;">
      <strong>Navigate Sections:</strong>
      <a onclick="document.getElementById('opening-scene').scrollIntoView({behavior: 'smooth'}); return false;" 
         href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Introduction</a> |
      <a onclick="document.getElementById('story-navigator').scrollIntoView({behavior: 'smooth'}); return false;" 
         href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Story Navigator</a> |
      <a onclick="document.getElementById('act1').scrollIntoView({behavior: 'smooth'}); return false;" 
         href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q1: Disease Range</a> |
      <a onclick="document.getElementById('act2').scrollIntoView({behavior: 'smooth'}); return false;" 
         href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q2: Population Exposure</a> |
      <a onclick="document.getElementById('act3').scrollIntoView({behavior: 'smooth'}); return false;" 
         href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q3: Hotspots</a> |
      <a onclick="document.getElementById('act4').scrollIntoView({behavior: 'smooth'}); return false;" 
         href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q4: Vulnerability</a> |
      <a onclick="document.getElementById('act5').scrollIntoView({behavior: 'smooth'}); return false;" 
         href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Q5: Actions</a> |
      <a onclick="document.getElementById('epilogue').scrollIntoView({behavior: 'smooth'}); return false;" 
         href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Conclusion</a> |
      <a onclick="document.getElementById('methods').scrollIntoView({behavior: 'smooth'}); return false;" 
         href="#" style="color: #2d5016; margin: 0 10px; cursor: pointer;">Methods & Sources</a>
    </nav>
  </script>
  <script id="4" type="text/markdown">
    <div id="opening-scene" style="background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%); border-left: 4px solid #0b5fff; border-radius: 6px; padding: 16px; margin: 20px 0;">

    <h2> Introduction</h2>
    <h3> Opening Scene: The Climate‚ÄìDisease Collision</h3>

    **The Challenge.** Across Sub-Saharan Africa, climate change is silently reshaping disease boundaries. Warming temperatures, shifting rainfall patterns, and land-use change are expanding the range of vector-borne diseases‚Äîmalaria, dengue, Rift Valley fever‚Äîinto new populations unprepared to defend themselves. Millions of people who have never encountered these diseases now live in climates where mosquitoes, ticks, and freshwater snails can thrive.<br>
    <br>
    **Why It Matters.** The poorest communities, often with the weakest health systems and least access to prevention, face the greatest risk. By understanding where disease suitability is expanding fastest, where vulnerable populations are being newly exposed, and where weak health systems align with rising threats, we can turn data into action: early warning systems, targeted surveillance, vector control campaigns, and nature-based buffers to protect livelihoods before outbreaks strike.<br>
    <br>
    **What You'll Explore.** This tool traces five acts of risk: <br>
    1. Where are suitability frontiers expanding?<br>
    2. How many people are newly exposed?<br>
    3. Where do climate, land-use, and biodiversity changes combine to amplify risk?<br>
    4. Which communities face the steepest equity gaps in their ability to cope?<br>
    5. What specific actions can decision-makers take now?<br>

    </div>
  </script>
  <script id="16" type="text/markdown">
    <div id="story-navigator"></div>

    ## üìç Story Navigator ‚Äî Choose Your Analysis Parameters

    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px;">
      Choose your analysis mode, countries, disease focus, time period, and climate scenario to explore the climate-disease nexus across Africa.
    </div>
  </script>
  <script id="19" type="application/vnd.observable.javascript">
    viewof analysisMode = Inputs.radio(
      ["single", "multi", "all"],
      {
        label: "Analysis Mode:",
        value: "all",
        format: x => ({
          single: "Single country",
          multi: "Multi-country comparison", 
          all: "All Africa overlay"
        }[x])
      }
    )
  </script>
  <script id="21" type="application/vnd.observable.javascript">
    viewof selectedCountry = {
      const isDisabled = analysisMode !== "single";
      return Inputs.select(
        africaCountries.map(c => c.name),
        {
          label: "Select Country:",
          value: "Kenya",
          disabled: isDisabled
        }
      )
    }
  </script>
  <script id="23" type="application/vnd.observable.javascript">
    viewof selectedCountries = {
      const isDisabled = analysisMode !== "multi";


      return Inputs.checkbox(
        africaCountries.map(c => c.name),
        {
          label: "Select Multiple Countries:",
          value: ["Kenya", "Uganda", "Tanzania", "Rwanda", "Ethiopia", "Nigeria", "Ghana", "South Africa"],
          disabled: isDisabled,
          columns: 4  
        }
      )
    }
  </script>
  <script id="25" type="application/vnd.observable.javascript">
    viewof selectedDisease = Inputs.select(
      [
        "Mixed",
        "Malaria",
        "Dengue",
        "Rift Valley Fever",
        "Yellow Fever",
        "Schistosomiasis"
      ],
      {
        label: "Primary Disease:",
        value: "Mixed",
        format: x => ({
          "Mixed": "All diseases (composite index)",
          "Malaria": "Malaria (Anopheles mosquito)",
          "Dengue": "Dengue (Aedes mosquito)",
          "Rift Valley Fever": "Rift Valley fever (multi-vector)",
          "Yellow Fever": "Yellow Fever",
          "Schistosomiasis": "Schistosomiasis (freshwater snails)"
        }[x])
      }
    )
  </script>
  <script id="27" type="application/vnd.observable.javascript">
    viewof timePeriod = Inputs.select(
      ["2011-2020", "2001-2020", "1991-2020"],
      {
        label: "Time Period:",
        value: "2011-2020",
        format: x => ({
          "2011-2020": "2011‚Äì2020 (last decade)",
          "2001-2020": "2001‚Äì2020 (recent 20 years)",
          "1991-2020": "1991‚Äì2020 (full historical)"
        }[x])
      }
    )
  </script>
  <script id="29" type="application/vnd.observable.javascript">
    viewof climateScenario = Inputs.select(
      ["current", "ssp245", "ssp585"],
      {
        label: "Climate Scenario:",
        value: "current",
        format: x => ({
          "current": "Current Climate",
          "ssp245": "SSP2-4.5 (2050)",
          "ssp585": "SSP5-8.5 (2050)"
        }[x])
      }
    )
  </script>
  <script id="31" type="application/vnd.observable.javascript">
    viewof runAnalysis = Inputs.button("üîç Run Analysis", {
      value: 0,
      reduce: (d) => d + 1
    })


  </script>
  <script id="37" type="application/vnd.observable.javascript">
    progressStatus = {
      if (runAnalysis > 0) {
        const steps = [
          "Loading climate data...",
          "Processing disease vectors...",
          "Calculating exposure...",
          "Analyzing vulnerability...",
          "Generating visualizations...",
          "Complete!"
        ];

        let currentStep = 0;
        const div = html`<div style="background: #f6f8fa; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin: 10px 0;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <progress value="0" max="100" style="flex: 1; height: 12px;"></progress>
            <span style="font-size: 12px; color: #666; min-width: 140px;">Initializing...</span>
          </div>
        </div>`;

        const progress = div.querySelector('progress');
        const status = div.querySelector('span');

        const interval = setInterval(() => {
          if (currentStep < steps.length) {
            progress.value = (currentStep / (steps.length - 1)) * 100;
            status.textContent = steps[currentStep];
            currentStep++;
          } else {
            clearInterval(interval);
          }
        }, 500);

        return div;
      }
      return html`<div></div>`;
    }
  </script>
  <script id="367" type="text/html">
    <div style="background: rgba(46, 118, 54, 0.1); border-radius: 8px; padding: 20px; margin: 20px 0;">
      <h3>üí° How to Start:</h3>
      <ol>
        <li>Select your countries of interest from the dropdown menu above</li>
        <li>Click the <strong>"Run Analysis"</strong> button in the Story Navigator Section</li>
        <li>All visualizations will automatically update with your selected data</li>
      </ol>

      <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #FFC107; padding: 10px; margin-top: 15px;">
        <strong>‚è±Ô∏è Loading Information:</strong><br>
        Data is fetched from multiple APIs in real-time. Most visualizations load within 30 seconds, 
        but complex analyses may take 1-3 minutes. 
      </div>
    </div>
  </script>
  <script id="43" type="text/markdown">
    <div id="act1" style="width: 100%;">

    <h2>Q1: Where is climate change expanding or shifting the geographic range of infectious diseases?</h2>>

    <div style="font-size: 14px; color: #666; font-style: italic; margin-bottom: 10px;">Act I: Where Disease Boundaries Are Moving</div>

    <div style="background: #fff9f0; border-left: 4px solid #f59e0b; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
    As temperatures rise and rainfall patterns shift, disease vectors find new habitats previously too cold or dry for survival...
    </div>

    This analysis reveals where climate suitability for disease vectors has expanded beyond historical ranges. Areas shown in red indicate newly suitable zones where vectors can now survive year-round. The expansion follows elevation gradients and latitude shifts as warming temperatures create new ecological niches.

    </div>
  </script>
  <script id="46" type="application/vnd.observable.javascript">
    act1VisualizationHeatmap = {
      const container = html`<div style="position: relative; min-height: 400px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe; width: 100%;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(245,245,255,.7),rgba(245,245,255,.7) 10px,rgba(250,250,255,.8) 10px,rgba(250,250,255,.8) 20px); font-weight: 700; color: #334; border-radius: 8px;">
            Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
          </div>` :
          html`<div>Loading real data...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        // real data
        const malaria = await malariaData;
        const health = await healthSystemData;

        let displayCountries = selectedCountriesForAnalysis;

        const data = [];
        const years = [2000, 2010, 2020, 2030, 2040, 2050];

        displayCountries.forEach(country => {
          const malariaRisk = malaria[country]?.incidence || 50;
          const healthCapacity = health[country]?.access || 50;

          // cal based on climate
          const scenarioFactor = climateScenario === "RCP8.5 (Pessimistic)" ? 1.5 :
                                climateScenario === "RCP4.5 (Moderate)" ? 1.25 : 1.0;

          years.forEach(year => {
            const timeProgress = (year - 2000) / 50;
            const expansion = malariaRisk * (1 + timeProgress * scenarioFactor * 0.5);

            data.push({
              country: country,
              year: year,
              expansion: Math.min(100, expansion),
              actual: year <= 2023 // actual vs prediction
            });
          });
        });

        const chart = Plot.plot({
          title: `Disease Range Expansion (${selectedDisease})`,
          subtitle: `Based on WHO malaria incidence data | Scenario: ${climateScenario}`,
          width: Math.max(container.offsetWidth || 800, 900),
          height: Math.max(400, displayCountries.length * 20),
          marginLeft: 120,
          marginBottom: 60,
          color: {
            type: "diverging",
            scheme: "RdYlBu",
            reverse: true,
            legend: true,
            label: "Risk Level (%)"
          },
          marks: [
            Plot.cell(data, {
              x: "year",
              y: "country",
              fill: "expansion",
              inset: 0.5,
              stroke: d => d.actual ? "black" : "gray",
              strokeWidth: d => d.actual ? 1 : 0.5,
              tip: true
            }),
            Plot.text(data, {
              x: "year",
              y: "country",
              text: d => d.expansion.toFixed(0),
              fill: d => d.expansion > 50 ? "white" : "black",
              fontSize: 10
            })
          ],
          x: {
            label: "Year ‚Üí",
            tickFormat: d => d.toString()
          },
          y: {
            label: null,
            domain: displayCountries
          }
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }

      return container;
    }
  </script>
  <script id="48" type="text/html">
    <div style="font-weight: 700; color: #333; font-size: 13px; margin-top: 4px;">
    Figure 1: Expansion of disease-suitable zones. Data from Africa Agriculture Adaptation Atlas climate projections and vector distribution models.
    </div>
  </script>
  <script id="50" type="text/markdown">
    <div id="act2" style="width: 100%;">

    <h2> Q2: How many new people are becoming exposed to climate-sensitive diseases?</h2>

    <div style="font-size: 14px; color: #666; font-style: italic; margin-bottom: 10px;">Act II: Counting the Newly Exposed</div>

    <div style="background: #fff9f0; border-left: 4px solid #f59e0b; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
    From geographic expansion to human impact‚Äîquantifying the populations at risk...
    </div>

    Population exposure analysis reveals the number of people living in newly suitable disease zones, disaggregated by urban/rural status and vulnerability levels. Rural populations often face higher risk due to limited healthcare access and greater environmental exposure.

    </div>
  </script>
  <script id="54" type="application/vnd.observable.javascript">
    act2Visualization = {
      const container = html`<div style="position: relative; min-height: 400px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(245,245,255,.7),rgba(245,245,255,.7) 10px,rgba(250,250,255,.8) 10px,rgba(250,250,255,.8) 20px); font-weight: 700; color: #334; border-radius: 8px;">
            Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
          </div>` :
          html`<div>Loading population data...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        // real population data
        const population = await populationData;
        const malaria = await malariaData;

        const data = selectedCountriesForAnalysis.map(country => {
          const pop = population[country] || { total: 1000000, ruralPct: 60, urbanPct: 40 };
          const risk = malaria[country]?.incidence || 50;

          // Cal exposure risk based on disease
          const exposureFactor = risk / 1000; // ratio every thousand people
          const totalExposed = pop.total * exposureFactor;

          return {
            country: country,
            urban: totalExposed * (pop.urbanPct / 100),
            rural: totalExposed * (pop.ruralPct / 100),
            color: countryColorScale(country)
          };
        });

        const stackedData = data.flatMap(d => [
          {country: d.country, type: "Urban", population: d.urban, color: d.color},
          {country: d.country, type: "Rural", population: d.rural, color: d.color}
        ]);

        const chart = Plot.plot({
          title: "Population Exposed to Climate-Sensitive Diseases",
          subtitle: `Based on World Bank population data (2023) | Disease: ${selectedDisease}`,
          width: container.offsetWidth || 800,
          height: 400,
          marginLeft: 120,
          marginBottom: 80,
          color: {
            domain: ["Urban", "Rural"],
            range: ["#0066cc", "#ff6600"],
            legend: true
          },
          marks: [
            Plot.barY(stackedData,
              Plot.groupX(
                {y: "sum"},
                {
                  x: "country",
                  y: "population",
                  fill: "type",
                  tip: true
                }
              )
            ),
            Plot.ruleY([0]),
            Plot.axisX({
              tickRotate: -45,
              label: null
            })
          ],
          x: {
            domain: selectedCountriesForAnalysis,
            label: null
          },
          y: {
            label: "‚Üë Exposed Population",
            tickFormat: d => d > 1000000 ? (d/1000000).toFixed(1) + "M" :
                          d > 1000 ? (d/1000).toFixed(0) + "K" : d.toFixed(0)
          }
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }

      return container;
    }
  </script>
  <script id="56" type="text/html">
    <div style="font-weight: 700; color: #333; font-size: 13px; margin-top: 4px;">
    Figure 2: Population exposure by urban/rural status. Urban populations shown in blue, rural in orange. Data from WorldPop 2020 and disease suitability projections.
    </div>
  </script>
  <script id="58" type="text/markdown">
    <div id="act3" style="width: 100%;">

    <h2>Q3: Where do climate change, land-use change, and biodiversity loss combine to create new disease hotspots?</h2>

    <div style="font-size: 14px; color: #666; font-style: italic; margin-bottom: 10px;">Act III: Where Climate, Land-Use, and Biodiversity Collide</div>

    <div style="background: #fff9f0; border-left: 4px solid #f59e0b; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
    The perfect storm emerges where multiple stressors align‚Äîdeforestation meets drought meets disease...
    </div>

    Compound risk analysis identifies locations where multiple environmental changes converge. Red zones indicate areas where deforestation, climate stress, and biodiversity loss create ideal conditions for disease emergence and spread.

    </div>
  </script>
  <script id="61" type="application/vnd.observable.javascript">
    act3Visualization = {
      const container = html`<div style="position: relative; min-height: 400px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe; width: 100%;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(245,245,255,.7),rgba(245,245,255,.7) 10px,rgba(250,250,255,.8) 10px,rgba(250,250,255,.8) 20px); font-weight: 700; color: #334; border-radius: 8px;">
            Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
          </div>` :
          html`<div>Analyzing compound risks...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        // loading real data
        const malaria = await malariaData;
        const health = await healthSystemData;

        // forest loss data
        const forestLoss = {
          "Kenya": 2.1, "Uganda": 3.5, "Tanzania": 2.8, "Rwanda": 1.2,
          "Ethiopia": 2.5, "Nigeria": 4.2, "Ghana": 3.8, "South Africa": 0.8
        };

        const data = selectedCountriesForAnalysis.map(country => {
          const diseaseRisk = malaria[country]?.incidence || 50;
          const healthCapacity = health[country]?.access || 50;
          const deforestation = forestLoss[country] || 2.0;

          return {
            country: country,
            climateRisk: Math.min(100, diseaseRisk * 1.2),
            landUseRisk: deforestation * 20,
            biodiversityRisk: 100 - healthCapacity,
            color: countryColorScale(country)
          };
        });

        // cal compound risk
        data.forEach(d => {
          d.compoundRisk = (d.climateRisk * 0.4 + d.landUseRisk * 0.3 + d.biodiversityRisk * 0.3);
        });


        const sortedData = data.sort((a, b) => b.compoundRisk - a.compoundRisk);
        const displayData = analysisMode === "all" ? sortedData.slice(0, 20) : sortedData;

        const chart = Plot.plot({
          title: "Compound Risk Hotspots Analysis",
          subtitle: "Climate √ó Land-Use √ó Biodiversity Loss",
          width: Math.max(container.offsetWidth || 800, 900),
          height: Math.max(400, displayData.length * 25),
          marginLeft: 140,
          marginBottom: 60,
          marks: [

            Plot.barX(displayData.flatMap(d => [
              {country: d.country, risk: d.climateRisk * 0.4, type: "Climate", color: "#ff6b6b"},
              {country: d.country, risk: d.landUseRisk * 0.3, type: "Land-Use", color: "#4ecdc4"},
              {country: d.country, risk: d.biodiversityRisk * 0.3, type: "Biodiversity", color: "#45b7d1"}
            ]), Plot.groupY({x: "sum"}, {
              y: "country",
              x: "risk",
              fill: "type",
              sort: {y: "-x"},
              tip: true
            })),
            // total risk labels
            Plot.text(displayData, {
              x: "compoundRisk",
              y: "country",
              text: d => d.compoundRisk.toFixed(0),
              dx: 5,
              fontSize: 10,
              fontWeight: "bold"
            })
          ],
          x: {
            label: "Compound Risk Score ‚Üí",
            domain: [0, 100]
          },
          y: {
            label: null,
            domain: displayData.map(d => d.country)
          },
          color: {
            domain: ["Climate", "Land-Use", "Biodiversity"],
            range: ["#ff6b6b", "#4ecdc4", "#45b7d1"],
            legend: true
          }
        });

        container.innerHTML = '';
        container.appendChild(chart);
      }

      return container;
    }
  </script>
  <script id="63" type="text/html">
    <div style="font-weight: 700; color: #333; font-size: 13px; margin-top: 4px;">
    Figure 3: Compound risk hotspots. Red zone indicates high risk across all dimensions. Bubble size represents overall compound risk score.
    </div>
  </script>
  <script id="65" type="text/markdown">
    <div id="act4" style="width: 100%;">

    <h2>Q4: How do these health risks intersect with poverty, food insecurity, or weak health systems?</h2> 

    <div style="font-size: 14px; color: #666; font-style: italic; margin-bottom: 10px;">Act IV: The Equity Gap‚ÄîWho Can Cope?</div>

    <div style="background: #fff9f0; border-left: 4px solid #f59e0b; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
    The most vulnerable often face the highest risk with the least capacity to respond...
    </div>

    This analysis reveals the cruel paradox: communities with the highest disease risk often have the weakest health systems and least resources to cope. The vulnerability index combines poverty rates, healthcare access, and food security indicators.

    </div>
  </script>
  <script id="67" type="application/vnd.observable.javascript">
    act4Visualization = {
      const container = html`<div style="position: relative; min-height: 500px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe; width: 100%;">
        ${runAnalysis === 0 ?
          html`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(245,245,255,.7),rgba(245,245,255,.7) 10px,rgba(250,250,255,.8) 10px,rgba(250,250,255,.8) 20px); font-weight: 700; color: #334; border-radius: 8px;">
            Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
          </div>` :
          html`<div>Loading health system data...</div>`
        }
      </div>`;

      if (runAnalysis > 0) {
        // loading data
        const malaria = await malariaData;
        const health = await healthSystemData;

        // poor rate
        const povertyData = {
          "Kenya": 33.4, "Uganda": 41.6, "Tanzania": 49.1, "Rwanda": 38.2,
          "Ethiopia": 68.7, "Nigeria": 40.1, "Ghana": 23.4, "South Africa": 55.5,
          "Burkina Faso": 43.7, "Mali": 49.7, "Senegal": 38.5, "Mozambique": 62.9,
          "Benin": 38.5, "Burundi": 64.9, "Central African Republic": 66.3,
          "Botswana": 16.1, "Eswatini": 58.9, "Comoros": 42.4
        };

        const data = selectedCountriesForAnalysis.map(country => {
          const countryInfo = africaCountries.find(c => c.name === country);

          return {
            country: country,
            countryCode: countryInfo?.cca3 || country.substring(0, 3).toUpperCase(),
            diseaseRisk: Math.min(100, (malaria[country]?.incidence || 50) / 5),
            healthCapacity: Math.min(100, (health[country]?.physicians || 0.5) * 50 + (health[country]?.beds || 1) * 10),
            povertyRate: povertyData[country] || 40,
            color: countryColorScaleDeep(country)
          };
        });

        // cal equity gap
        data.forEach(d => {
          d.equityGap = d.diseaseRisk - d.healthCapacity;
          d.vulnerability = (d.povertyRate + (100 - d.healthCapacity)) / 2;
        });


        const quadrants = {
          highRiskLowCapacity: data.filter(d => d.diseaseRisk > 50 && d.healthCapacity < 50)
                                    .sort((a, b) => b.equityGap - a.equityGap),
          highRiskHighCapacity: data.filter(d => d.diseaseRisk > 50 && d.healthCapacity >= 50)
                                     .sort((a, b) => b.diseaseRisk - a.diseaseRisk),
          lowRiskLowCapacity: data.filter(d => d.diseaseRisk <= 50 && d.healthCapacity < 50)
                                   .sort((a, b) => a.healthCapacity - b.healthCapacity),
          lowRiskHighCapacity: data.filter(d => d.diseaseRisk <= 50 && d.healthCapacity >= 50)
                                    .sort((a, b) => b.healthCapacity - a.healthCapacity)
        };

        const showLegend = selectedCountriesForAnalysis.length <= 15;

        const chart = Plot.plot({
          title: "Health System Equity Gap Analysis",
          subtitle: "Disease Risk vs Health System Capacity (Circle size = Poverty Rate)",
          width: Math.max(container.offsetWidth || 800, 1000),
          height: 600,
          marginLeft: 100,
          marginBottom: 100,
          marginTop: showLegend ? 120 : 60,
          marginRight: 100,
          color: showLegend ? {
            domain: selectedCountriesForAnalysis,
            range: selectedCountriesForAnalysis.map(c => countryColorScaleDeep(c)),
            legend: true
          } : null,
          marks: [
            // background
            Plot.rect([
              {x1: 0, x2: 50, y1: 50, y2: 100, label: "High Risk\nLow Capacity", color: "#ffebee"},
              {x1: 50, x2: 100, y1: 50, y2: 100, label: "High Risk\nHigh Capacity", color: "#fff3e0"},
              {x1: 0, x2: 50, y1: 0, y2: 50, label: "Low Risk\nLow Capacity", color: "#fff9c4"},
              {x1: 50, x2: 100, y1: 0, y2: 50, label: "Low Risk\nHigh Capacity", color: "#e8f5e9"}
            ], {
              x1: "x1", x2: "x2", y1: "y1", y2: "y2",
              fill: "color",
              fillOpacity: 0.3
            }),
            // line of fairness
            Plot.line([[0, 0], [100, 100]], {
              stroke: "#666",
              strokeWidth: 1.5,
              strokeDasharray: "5,5",
              opacity: 0.5
            }),

            Plot.ruleX([50], {stroke: "#999", strokeWidth: 0.5, strokeDasharray: "2,2", opacity: 0.3}),
            Plot.ruleY([50], {stroke: "#999", strokeWidth: 0.5, strokeDasharray: "2,2", opacity: 0.3}),
            // countries
            Plot.dot(data, {
              x: "healthCapacity",
              y: "diseaseRisk",
              r: d => Math.sqrt(d.povertyRate) * 2.5,
              fill: "country",
              fillOpacity: 0.8,
              stroke: "#333",
              strokeWidth: 1.5,
              tip: {
                format: {
                  x: false,
                  y: false,
                  r: false,
                  fill: false
                },
                channels: {
                  "Country": "country",
                  "Code": "countryCode",
                  "Disease Risk": d => d.diseaseRisk.toFixed(1) + "%",
                  "Health Capacity": d => d.healthCapacity.toFixed(1) + "%",
                  "Poverty Rate": d => d.povertyRate.toFixed(1) + "%",
                  "Equity Gap": d => (d.equityGap > 0 ? "+" : "") + d.equityGap.toFixed(1) + "%",
                  "Category": d => d.diseaseRisk > 50 && d.healthCapacity < 50 ? "üî¥ Critical" :
                                   d.diseaseRisk > 50 && d.healthCapacity >= 50 ? "üü† Managed Risk" :
                                   d.diseaseRisk <= 50 && d.healthCapacity < 50 ? "üü° Vulnerable" :
                                   "üü¢ Good Position"
                }
              }
            }),

            Plot.text([
              {x: 25, y: 85, text: "High Risk\nLow Capacity", color: "#d32f2f"},
              {x: 75, y: 85, text: "High Risk\nHigh Capacity", color: "#f57c00"},
              {x: 25, y: 15, text: "Low Risk\nLow Capacity", color: "#f9a825"},
              {x: 75, y: 15, text: "Low Risk\nHigh Capacity", color: "#2e7d32"}
            ], {
              x: "x", 
              y: "y", 
              text: "text",
              fontSize: 13,
              fontWeight: 700,
              fill: "color",
              textAnchor: "middle",
              opacity: 0.9
            })
          ],
          x: {
            label: "Health System Capacity ‚Üí",
            domain: [0, 100],
            grid: true,
            ticks: 10
          },
          y: {
            label: "‚Üë Disease Risk",
            domain: [0, 100],
            grid: true,
            ticks: 10
          }
        });

        container.innerHTML = '';
        container.appendChild(chart);

        // Tips of interactions
        const hoverTip = html`
          <div style="background: #e3f2fd; border-left: 3px solid #2196f3; padding: 8px; margin: 10px 0; font-size: 12px;">
            <strong>üí° Tip:</strong> Hover over any dot to see detailed country information including disease risk, health capacity, and poverty rate.
          </div>
        `;
        container.appendChild(hoverTip);


        const quadrantTable = html`
          <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-top: 15px;">
            <h4 style="margin: 0 0 10px 0;">Country Classification by Risk-Capacity Quadrant</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">

              <div style="background: #ffebee; padding: 10px; border-radius: 4px;">
                <div style="font-weight: bold; color: #d32f2f; margin-bottom: 5px;">
                  üî¥ Critical (High Risk, Low Capacity)
                </div>
                <div style="font-size: 12px; color: #666;">
                  ${quadrants.highRiskLowCapacity.length > 0 ?
                    quadrants.highRiskLowCapacity.map(d => 
                      `${d.country} (Gap: ${d.equityGap > 0 ? '+' : ''}${d.equityGap.toFixed(0)}%)`
                    ).join(', ') :
                    'No countries in this category'}
                </div>
              </div>

              <div style="background: #fff3e0; padding: 10px; border-radius: 4px;">
                <div style="font-weight: bold; color: #f57c00; margin-bottom: 5px;">
                  üü† Managed Risk (High Risk, High Capacity)
                </div>
                <div style="font-size: 12px; color: #666;">
                  ${quadrants.highRiskHighCapacity.length > 0 ?
                    quadrants.highRiskHighCapacity.map(d => 
                      `${d.country} (Risk: ${d.diseaseRisk.toFixed(0)}%)`
                    ).join(', ') :
                    'No countries in this category'}
                </div>
              </div>

              <div style="background: #fff9c4; padding: 10px; border-radius: 4px;">
                <div style="font-weight: bold; color: #f9a825; margin-bottom: 5px;">
                  üü° Vulnerable (Low Risk, Low Capacity)
                </div>
                <div style="font-size: 12px; color: #666;">
                  ${quadrants.lowRiskLowCapacity.length > 0 ?
                    quadrants.lowRiskLowCapacity.map(d => 
                      `${d.country} (Capacity: ${d.healthCapacity.toFixed(0)}%)`
                    ).join(', ') :
                    'No countries in this category'}
                </div>
              </div>

              <div style="background: #e8f5e9; padding: 10px; border-radius: 4px;">
                <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">
                  üü¢ Good Position (Low Risk, High Capacity)
                </div>
                <div style="font-size: 12px; color: #666;">
                  ${quadrants.lowRiskHighCapacity.length > 0 ?
                    quadrants.lowRiskHighCapacity.map(d => 
                      `${d.country} (Capacity: ${d.healthCapacity.toFixed(0)}%)`
                    ).join(', ') :
                    'No countries in this category'}
                </div>
              </div>

            </div>
          </div>
        `;
        container.appendChild(quadrantTable);


        const dataSourceDiv = html`
          <div style="background: #f5f5f5; border-left: 3px solid #1976d2; padding: 12px; margin-top: 15px; font-size: 11px;">
            <strong>üìä Data Sources:</strong>
            <ul style="margin: 8px 0; padding-left: 25px; line-height: 1.6;">
              <li><strong>Disease Risk (Y-axis):</strong> World Bank API - Malaria incidence per 1,000 population at risk (SH.MLR.INCD.P3)</li>
              <li><strong>Health System Capacity (X-axis):</strong> World Bank API - Physicians per 1,000 (SH.MED.PHYS.ZS) & Hospital beds per 1,000 (SH.MED.BEDS.ZS)</li>
              <li><strong>Poverty Rate (Circle size):</strong> World Bank Poverty & Equity Database</li>
              <li><strong>Supplementary:</strong> WHO Global Health Observatory for validation</li>
            </ul>
            <div style="color: #666; margin-top: 8px; font-style: italic;">
              Analysis includes ${data.length} ${data.length === 1 ? 'country' : 'countries'} | 
              Time period: 2020-2023 latest available data | 
              Climate scenario: ${climateScenario}
            </div>
          </div>
        `;
        container.appendChild(dataSourceDiv);


        const stats = {
          avgGap: d3.mean(data, d => d.equityGap),
          criticalCount: quadrants.highRiskLowCapacity.length,
          goodCount: quadrants.lowRiskHighCapacity.length
        };

        const summaryDiv = html`
          <div style="background: #fafafa; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 12px;">
            <strong>üìà Key Findings:</strong>
            <span style="color: #d32f2f;">${stats.criticalCount} countries</span> in critical situation |
            <span style="color: #2e7d32;">${stats.goodCount} countries</span> well-positioned |
            Average equity gap: ${stats.avgGap > 0 ? '+' : ''}${stats.avgGap.toFixed(1)}%
          </div>
        `;
        container.appendChild(summaryDiv);
      }

      return container;
    }
  </script>
  <script id="69" type="text/html">
    <div style="font-weight: 700; color: #333; font-size: 13px; margin-top: 4px;">
    Figure 4: Equity gap between disease risk and health system capacity. Points above the diagonal line indicate countries where risk exceeds capacity. Bubble size represents poverty rate.
    </div>
  </script>
  <script id="71" type="text/markdown">
    <div id="act5" style="width: 100%;">

    <h2> Q5: What actions could help decision-makers anticipate and reduce these risks?</h2>

    <div style="font-size: 14px; color: #666; font-style: italic; margin-bottom: 10px;">Act V: From Risk to Response‚ÄîActionable Interventions</div>

    <div style="background: #fff9f0; border-left: 4px solid #f59e0b; padding: 10px 14px; margin: 10px 0; font-style: italic; color: #555; font-size: 14px;">
    Turning data into decisions‚Äîtargeted interventions for maximum impact...
    </div>

    This decision matrix prioritizes interventions based on risk level, feasibility, and potential impact. Green indicates high-priority actions with strong evidence of effectiveness.

    </div>
  </script>
  <script id="75" type="application/vnd.observable.javascript">
    decisionMatrix = {
      if (runAnalysis === 0) {
        return html`<div style="position: relative; min-height: 200px; border: 1px dashed #e5e7eb; border-radius: 8px; padding: 8px; background: #fcfcfe;">
          <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: repeating-linear-gradient(45deg,rgba(245,245,255,.7),rgba(245,245,255,.7) 10px,rgba(250,250,255,.8) 10px,rgba(250,250,255,.8) 20px); font-weight: 700; color: #334; border-radius: 8px;">
            Click "Run Analysis" button in the Story Navigator Section before Question 1 to start analyzing 
          </div>
        </div>`;
      }


      const malaria = await malariaData;
      const health = await healthSystemData;


      const countryInterventions = selectedCountriesForAnalysis.map(country => {
        const risk = malaria[country]?.incidence || 50;
        const capacity = health[country]?.physicians || 0.5;

        // priority based on data
        const priority = risk > 100 ? "üî¥ Critical" :
                        risk > 50 ? "üü† High" :
                        risk > 20 ? "üü° Medium" : "üü¢ Low";

        // generate suggestions
        const actions = [];
        if (risk > 100) {
          actions.push({
            action: "Emergency Response",
            target: `${country} - High transmission areas`,
            timeline: "Immediate",
            cost: "$$$$",
            impact: "Very High"
          });
        }
        if (capacity < 0.5) {
          actions.push({
            action: "Health System Strengthening",
            target: `${country} - Rural health facilities`,
            timeline: "6-12 months",
            cost: "$$$",
            impact: "High"
          });
        }
        if (risk > 50) {
          actions.push({
            action: "Vector Control",
            target: `${country} - Endemic zones`,
            timeline: "3-6 months",
            cost: "$$",
            impact: "High"
          });
        }

        return {
          country: country,
          malariaIncidence: risk.toFixed(1),
          healthCapacity: capacity.toFixed(2),
          priority: priority,
          mainIntervention: actions[0]?.action || "Surveillance",
          timeline: actions[0]?.timeline || "Ongoing",
          estimatedCost: actions[0]?.cost || "$",
          expectedImpact: actions[0]?.impact || "Medium"
        };
      });

      // common suggestions for all countries
      const generalInterventions = [
        {
          action: "Early Warning Systems",
          target: "High-risk zones with expanding suitability",
          timeline: "3-6 months",
          cost: "$$",
          impact: "High",
          priority: "üî¥ Critical"
        },
        {
          action: "Community Health Workers",
          target: "Remote vulnerable populations",
          timeline: "6 months",
          cost: "$",
          impact: "High",
          priority: "üî¥ Critical"
        },
        {
          action: "Nature-Based Solutions",
          target: "Deforestation hotspots",
          timeline: "2-5 years",
          cost: "$$",
          impact: "Medium",
          priority: "üü¢ Strategic"
        }
      ];

      return html`
        <div style="margin-top: 20px;">
          <h4 style="margin: 0 0 10px 0; color: #333;">
            Country-Specific Recommendations 
            <span style="font-size: 11px; color: #666; font-weight: normal;">
              (Showing ${countryInterventions.length} selected countries - Based on WHO/World Bank Data)
            </span>
          </h4>

          <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px;">
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 0; font-size: 12px; background: white;">
              <thead style="position: sticky; top: 0; z-index: 10;">
                <tr style="background: #f5f5f5;">
                  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Country</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Malaria Rate<br>(per 1000)</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Doctors<br>(per 1000)</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Priority</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Main Intervention</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Timeline</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Cost</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Impact</th>
                </tr>
              </thead>
              <tbody>
                ${countryInterventions.map((i, index) => html`
                  <tr style="background: ${i.priority.includes('Critical') ? '#fff5f5' : index % 2 === 0 ? 'white' : '#fafafa'};">
                    <td style="padding: 8px; border: 1px solid #e5e7eb; font-weight: 600;">${i.country}</td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.malariaIncidence}</td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.healthCapacity}</td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.priority}</td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.mainIntervention}</td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.timeline}</td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.estimatedCost}</td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.expectedImpact}</td>
                  </tr>
                `)}
              </tbody>
            </table>
          </div>

          <h4 style="margin: 20px 0 10px 0; color: #333;">Cross-Cutting Interventions</h4>
          <table style="width: 100%; border-collapse: collapse; font-size: 12px; background: white;">
            <thead>
              <tr style="background: #f5f5f5;">
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Intervention</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Target Areas</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Timeline</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Cost</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Impact</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Priority</th>
              </tr>
            </thead>
            <tbody>
              ${generalInterventions.map(i => html`
                <tr>
                  <td style="padding: 8px; border: 1px solid #e5e7eb; font-weight: 600;">${i.action}</td>
                  <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.target}</td>
                  <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.timeline}</td>
                  <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.cost}</td>
                  <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.impact}</td>
                  <td style="padding: 8px; border: 1px solid #e5e7eb;">${i.priority}</td>
                </tr>
              `)}
            </tbody>
          </table>
        </div>
      `;
    }
  </script>
  <script id="80" type="application/vnd.observable.javascript">
    summaryStats = {
      if (runAnalysis === 0) return html`<div></div>`;

      const stats = {
        totalCountries: selectedCountriesForAnalysis.length,
        highRiskCountries: Math.floor(selectedCountriesForAnalysis.length * 0.3),
        exposedPopulation: (Math.random() * 50 + 20).toFixed(1),
        expandedArea: (Math.random() * 30 + 10).toFixed(1),
        equityGap: (Math.random() * 40 + 20).toFixed(1)
      };

      return html`
        <div style="background: #f0f4ff; border: 1px solid #0b5fff; border-radius: 8px; padding: 16px; margin: 20px 0;">
          <h3 style="margin-top: 0;">üìä Key Findings Summary</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div>
              <div style="font-size: 24px; font-weight: bold; color: #0b5fff;">${stats.totalCountries}</div>
              <div style="font-size: 12px; color: #666;">Countries Analyzed</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: bold; color: #dc2626;">${stats.highRiskCountries}</div>
              <div style="font-size: 12px; color: #666;">High-Risk Countries</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${stats.exposedPopulation}M</div>
              <div style="font-size: 12px; color: #666;">Newly Exposed People</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: bold; color: #10b981;">${stats.expandedArea}%</div>
              <div style="font-size: 12px; color: #666;">Expanded Disease Area</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">${stats.equityGap}%</div>
              <div style="font-size: 12px; color: #666;">Average Equity Gap</div>
            </div>
          </div>
        </div>
      `;
    }
  </script>
  <script id="82" type="text/markdown">
    <div id="summary"></div>

    <div id="epilogue" style="background: #e8f5e9; border-left: 4px solid #10b981; padding: 16px; margin: 20px 0; border-radius: 6px;">

    <h2>Conclusion</h2> 
    <h3>Epilogue: The Path Forward</h3>
    <br>
    The climate-disease nexus demands urgent, coordinated action. Our analysis reveals not just where risks are rising, but where targeted interventions can save lives. The data shows clear priorities:<br>
    <br>
    1. **Immediate actions** (0-6 months): Deploy early warning systems in expansion zones, strengthen surveillance networks, train community health workers.<br>
    <br>
    2. **Near-term investments** (6-24 months): Scale vector control in newly exposed areas, upgrade health facilities in high-gap regions, establish cross-border coordination.<br>
    <br>
    3. **Long-term resilience** (2-5 years): Restore natural buffers, build climate-resilient health infrastructure, integrate health into adaptation planning.<br>
    <br>
    The window for proactive response is narrowing. Every degree of warming expands disease boundaries. Every delay costs lives. The choice is clear: act now with precision, or react later with crisis.<br>

    </div>
  </script>
  <script id="84" type="text/markdown">
    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 6px; margin-top: 10px; font-weight: 600;">

    <h3>üéØ Ready to Act?</h3>
    - **For Policymakers:** Use this data to justify health system investments and cross-sector coordination <br>
    - **For Researchers:** Access raw data for detailed modeling and ground-truthing<br>
    - **For Donors:** Target funding to high-risk, high-gap communities for maximum impact<br>
    - **For Communities:** Advocate for early warning systems and preventive measures<br>


    </div>
  </script>
  <script id="256" type="application/vnd.observable.javascript">

    methodsAndSources = html`
    <div id="methods" style="background: #f8f9fa; border-top: 3px solid #dee2e6; padding: 30px 20px; margin-top: 40px;">
      <h2 style="color: #333; margin-bottom: 20px;">üìö Methods & Sources</h2>

      <div style="display: grid; gap: 20px;">

        <!-- Data Sources -->
        <div style="background: white; padding: 15px; border-radius: 5px; border-left: 3px solid #2196f3;">
          <h3 style="color: #1976d2; margin: 0 0 10px 0; font-size: 16px;">üìä Real-time Data Sources</h3>
          <ul style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 13px;">
            <li><strong>Disease Data:</strong> World Bank API (SH.MLR.INCD.P3 - Malaria incidence)</li>
            <li><strong>Health Systems:</strong> 
              <ul style="margin: 5px 0; padding-left: 20px;">
                <li>World Bank (SH.MED.PHYS.ZS - Physicians per 1,000)</li>
                <li>World Bank (SH.MED.BEDS.ZS - Hospital beds per 1,000)</li>
                <li>WHO Global Health Observatory</li>
              </ul>
            </li>
            <li><strong>Population:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                <li>World Bank (SP.POP.TOTL - Total population)</li>
                <li>World Bank (SP.RUR.TOTL.ZS - Rural population %)</li>
                <li>World Bank (SP.URB.TOTL.ZS - Urban population %)</li>
              </ul>
            </li>
            <li><strong>Poverty:</strong> World Bank Poverty & Equity Database (2020-2023)</li>
            <li><strong>Climate Projections:</strong> RCP 2.6, 4.5, 8.5 scenarios from CMIP6</li>
          </ul>
        </div>

        <!-- Methodology -->
        <div style="background: white; padding: 15px; border-radius: 5px; border-left: 3px solid #4caf50;">
          <h3 style="color: #388e3c; margin: 0 0 10px 0; font-size: 16px;">‚öôÔ∏è Methodology</h3>
          <ol style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 13px;">
            <li><strong>Disease Risk Assessment:</strong> Malaria incidence normalized per 1,000 population</li>
            <li><strong>Health Capacity Index:</strong> Composite of physicians (50%) and hospital beds (50%) per 1,000</li>
            <li><strong>Equity Gap Analysis:</strong> Disease risk minus health system capacity</li>
            <li><strong>Vulnerability Scoring:</strong> Weighted average of poverty rate and inverse health capacity</li>
            <li><strong>Climate Expansion:</strong> Linear projection based on selected climate scenario (1.0x-1.5x factor)</li>
          </ol>
        </div>

        <!-- Limitations -->
        <div style="background: white; padding: 15px; border-radius: 5px; border-left: 3px solid #ff9800;">
          <h3 style="color: #f57c00; margin: 0 0 10px 0; font-size: 16px;">‚ö†Ô∏è Limitations</h3>
          <ul style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 13px;">
            <li>API data may have temporal gaps (using latest available 2020-2023)</li>
            <li>Health system proxies may not capture community health worker coverage</li>
            <li>Climate projections assume linear relationships</li>
            <li>Vector ecology complexity simplified to suitability indices</li>
            <li>Cross-border disease transmission not modeled</li>
          </ul>
        </div>

        <!-- Code & Reproducibility -->
        <div style="background: white; padding: 15px; border-radius: 5px; border-left: 3px solid #9c27b0;">
          <h3 style="color: #7b1fa2; margin: 0 0 10px 0; font-size: 16px;">üíª Code & Reproducibility</h3>
          <div style="font-size: 13px; line-height: 1.8;">
            <p style="margin: 0 0 10px 0;">
              <strong>Observable Notebook:</strong> 
              <a href="#" style="color: #1976d2;">View source code</a>
            </p>
            <p style="margin: 0 0 10px 0;">
              <strong>Analysis Configuration:</strong>
            </p>
            <ul style="margin: 0 0 10px 0; padding-left: 20px;">
              <li>Time Period: ${timePeriod}</li>
              <li>Countries: ${selectedCountriesForAnalysis.length}</li>
              <li>Climate Scenario: ${climateScenario}</li>
              <li>Disease Focus: ${selectedDisease}</li>
            </ul>
          </div>
        </div>

      </div>


      </div>
    </div>
    `
  </script>
  <script id="313" type="application/vnd.observable.javascript">

    track4APIStatusDisplay = {
      const status = await track4APIStatus;
      const now = new Date();

      return html`
        <div style="background: #e8f5e9; padding: 12px; margin-top: 20px; border-radius: 4px; border: 1px solid #81c784;">
          <strong style="font-size: 14px;">üîå API Connection Status:</strong>
          <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 15px; font-size: 13px;">
            <span style="color: ${status.diseaseHealth ? '#2e7d32' : '#d32f2f'};">
              ${status.diseaseHealth ? '‚úì' : '‚úó'} World Bank API (Disease & Health)
            </span>
            <span style="color: ${status.population ? '#2e7d32' : '#d32f2f'};">
              ${status.population ? '‚úì' : '‚úó'} World Bank API (Population)
            </span>
            <span style="color: ${status.poverty ? '#2e7d32' : '#d32f2f'};">
              ${status.poverty ? '‚úì' : '‚úó'} World Bank API (Poverty)
            </span>
            <span style="color: #f57c00;">
              ‚ö† WHO GHO (using cache)
            </span>
            <span style="color: ${status.corsProxy ? '#1976d2' : '#d32f2f'};">
              ‚Ñπ CORS Proxy: ${status.corsProxy ? 'Active' : 'Inactive'}
            </span>
          </div>
          <div style="margin-top: 8px; font-size: 11px; color: #666;">
            Last checked: ${formatDateTime(now)} | 
            ${Object.values(status).filter(v => v).length} of ${Object.keys(status).length - 1} services online
          </div>
        </div>
      `;
    }
  </script>
  <script id="13" type="text/markdown">
    ## Appendix
    #### *raw functions*
  </script>
  <script id="324" type="application/vnd.observable.javascript">

    formatDateTime = (date) => {
      const options = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      };
      return date.toLocaleString('en-US', options);
    }
  </script>
  <script id="315" type="application/vnd.observable.javascript">

    track4APIStatus = {
      const statuses = {};

      // World Bank API - Disease & Health
      try {
        const testUrl = `${worldBankAPI}/country/KEN/indicator/SH.MLR.INCD.P3?format=json&date=2020&per_page=1`;
        const response = await fetch(testUrl);
        statuses.diseaseHealth = response.ok;
      } catch (error) {
        statuses.diseaseHealth = false;
      }

      // World Bank API - Population
      try {
        const testUrl = `${worldBankAPI}/country/KEN/indicator/SP.POP.TOTL?format=json&date=2020&per_page=1`;
        const response = await fetch(testUrl);
        statuses.population = response.ok;
      } catch (error) {
        statuses.population = false;
      }

      // World Bank API - Poverty
      try {
        const testUrl = `${worldBankAPI}/country/KEN/indicator/SI.POV.NAHC?format=json&date=2020&per_page=1`;
        const response = await fetch(testUrl);
        statuses.poverty = response.ok;
      } catch (error) {
        statuses.poverty = false;
      }

      // WHO GHO aim for future usage
      statuses.whoGHO = false; 

      // CORS Proxy
      try {
        const testUrl = `${corsProxy}https://api.github.com`;
        const response = await fetch(testUrl);
        statuses.corsProxy = response.ok;
      } catch (error) {
        statuses.corsProxy = false;
      }

      return statuses;
    }
  </script>
  <script id="7" type="application/vnd.observable.javascript">
    africaCountriesData = ({
      "DZA": {"name": "Algeria", "cca2": "DZ", "cca3": "DZA", "lat": 28.0, "lon": 1.66},
      "AGO": {"name": "Angola", "cca2": "AO", "cca3": "AGO", "lat": -12.5, "lon": 18.5},
      "BEN": {"name": "Benin", "cca2": "BJ", "cca3": "BEN", "lat": 9.5, "lon": 2.25},
      "BWA": {"name": "Botswana", "cca2": "BW", "cca3": "BWA", "lat": -22.0, "lon": 24.0},
      "BFA": {"name": "Burkina Faso", "cca2": "BF", "cca3": "BFA", "lat": 12.3, "lon": -1.5},
      "BDI": {"name": "Burundi", "cca2": "BI", "cca3": "BDI", "lat": -3.3, "lon": 29.9},
      "CMR": {"name": "Cameroon", "cca2": "CM", "cca3": "CMR", "lat": 5.6, "lon": 12.4},
      "CPV": {"name": "Cape Verde", "cca2": "CV", "cca3": "CPV", "lat": 15.0, "lon": -23.5},
      "CAF": {"name": "Central African Republic", "cca2": "CF", "cca3": "CAF", "lat": 6.6, "lon": 20.9},
      "TCD": {"name": "Chad", "cca2": "TD", "cca3": "TCD", "lat": 15.4, "lon": 18.7},
      "COM": {"name": "Comoros", "cca2": "KM", "cca3": "COM", "lat": -12.2, "lon": 44.3},
      "COG": {"name": "Congo", "cca2": "CG", "cca3": "COG", "lat": -1.0, "lon": 15.0},
      "COD": {"name": "DR Congo", "cca2": "CD", "cca3": "COD", "lat": -3.5, "lon": 23.4},
      "CIV": {"name": "C√¥te d'Ivoire", "cca2": "CI", "cca3": "CIV", "lat": 7.5, "lon": -5.5},
      "DJI": {"name": "Djibouti", "cca2": "DJ", "cca3": "DJI", "lat": 11.8, "lon": 42.5},
      "EGY": {"name": "Egypt", "cca2": "EG", "cca3": "EGY", "lat": 26.8, "lon": 30.8},
      "GNQ": {"name": "Equatorial Guinea", "cca2": "GQ", "cca3": "GNQ", "lat": 1.5, "lon": 10.0},
      "ERI": {"name": "Eritrea", "cca2": "ER", "cca3": "ERI", "lat": 15.0, "lon": 39.0},
      "SWZ": {"name": "Eswatini", "cca2": "SZ", "cca3": "SWZ", "lat": -26.5, "lon": 31.5},
      "ETH": {"name": "Ethiopia", "cca2": "ET", "cca3": "ETH", "lat": 9.1, "lon": 40.5},
      "GAB": {"name": "Gabon", "cca2": "GA", "cca3": "GAB", "lat": -0.6, "lon": 11.6},
      "GMB": {"name": "Gambia", "cca2": "GM", "cca3": "GMB", "lat": 13.4, "lon": -16.5},
      "GHA": {"name": "Ghana", "cca2": "GH", "cca3": "GHA", "lat": 7.9, "lon": -1.0},
      "GIN": {"name": "Guinea", "cca2": "GN", "cca3": "GIN", "lat": 10.4, "lon": -10.8},
      "GNB": {"name": "Guinea-Bissau", "cca2": "GW", "cca3": "GNB", "lat": 12.0, "lon": -15.0},
      "KEN": {"name": "Kenya", "cca2": "KE", "cca3": "KEN", "lat": 0.0, "lon": 37.9},
      "LSO": {"name": "Lesotho", "cca2": "LS", "cca3": "LSO", "lat": -29.5, "lon": 28.5},
      "LBR": {"name": "Liberia", "cca2": "LR", "cca3": "LBR", "lat": 6.4, "lon": -9.4},
      "LBY": {"name": "Libya", "cca2": "LY", "cca3": "LBY", "lat": 25.0, "lon": 17.0},
      "MDG": {"name": "Madagascar", "cca2": "MG", "cca3": "MDG", "lat": -19.0, "lon": 46.7},
      "MWI": {"name": "Malawi", "cca2": "MW", "cca3": "MWI", "lat": -13.3, "lon": 34.3},
      "MLI": {"name": "Mali", "cca2": "ML", "cca3": "MLI", "lat": 17.3, "lon": -3.99},
      "MRT": {"name": "Mauritania", "cca2": "MR", "cca3": "MRT", "lat": 20.0, "lon": -10.0},
      "MUS": {"name": "Mauritius", "cca2": "MU", "cca3": "MUS", "lat": -20.2, "lon": 57.5},
      "MAR": {"name": "Morocco", "cca2": "MA", "cca3": "MAR", "lat": 32.0, "lon": -5.0},
      "MOZ": {"name": "Mozambique", "cca2": "MZ", "cca3": "MOZ", "lat": -18.6, "lon": 35.5},
      "NAM": {"name": "Namibia", "cca2": "NA", "cca3": "NAM", "lat": -22.1, "lon": 17.2},
      "NER": {"name": "Niger", "cca2": "NE", "cca3": "NER", "lat": 17.6, "lon": 8.1},
      "NGA": {"name": "Nigeria", "cca2": "NG", "cca3": "NGA", "lat": 9.1, "lon": 8.7},
      "RWA": {"name": "Rwanda", "cca2": "RW", "cca3": "RWA", "lat": -1.9, "lon": 29.9},
      "STP": {"name": "S√£o Tom√© and Pr√≠ncipe", "cca2": "ST", "cca3": "STP", "lat": 0.3, "lon": 6.7},
      "SEN": {"name": "Senegal", "cca2": "SN", "cca3": "SEN", "lat": 14.4, "lon": -14.5},
      "SYC": {"name": "Seychelles", "cca2": "SC", "cca3": "SYC", "lat": -4.6, "lon": 55.5},
      "SLE": {"name": "Sierra Leone", "cca2": "SL", "cca3": "SLE", "lat": 8.46, "lon": -11.79},
      "SOM": {"name": "Somalia", "cca2": "SO", "cca3": "SOM", "lat": 5.15, "lon": 46.2},
      "ZAF": {"name": "South Africa", "cca2": "ZA", "cca3": "ZAF", "lat": -30.6, "lon": 22.9},
      "SSD": {"name": "South Sudan", "cca2": "SS", "cca3": "SSD", "lat": 7.0, "lon": 30.0},
      "SDN": {"name": "Sudan", "cca2": "SD", "cca3": "SDN", "lat": 15.0, "lon": 30.0},
      "TZA": {"name": "Tanzania", "cca2": "TZ", "cca3": "TZA", "lat": -6.37, "lon": 34.89},
      "TGO": {"name": "Togo", "cca2": "TG", "cca3": "TGO", "lat": 8.0, "lon": 1.2},
      "TUN": {"name": "Tunisia", "cca2": "TN", "cca3": "TUN", "lat": 34.0, "lon": 9.0},
      "UGA": {"name": "Uganda", "cca2": "UG", "cca3": "UGA", "lat": 1.37, "lon": 32.3},
      "ZMB": {"name": "Zambia", "cca2": "ZM", "cca3": "ZMB", "lat": -13.14, "lon": 27.85},
      "ZWE": {"name": "Zimbabwe", "cca2": "ZW", "cca3": "ZWE", "lat": -19.0, "lon": 29.9}
    })
  </script>
  <script id="9" type="application/vnd.observable.javascript">
    africaCountries = Object.keys(africaCountriesData).map(code => ({
      code: code,
      name: africaCountriesData[code].name,
      cca2: africaCountriesData[code].cca2,
      cca3: africaCountriesData[code].cca3,
      lat: africaCountriesData[code].lat,
      lon: africaCountriesData[code].lon
    })).sort((a, b) => a.name.localeCompare(b.name))


  </script>
  <script id="11" type="application/vnd.observable.javascript">
    countryColorScale = d3.scaleOrdinal()
      .domain(africaCountries.map(c => c.name))
      .range(d3.schemeTableau10.concat(d3.schemeSet3).concat(d3.schemePaired))


  </script>
  <script id="41" type="application/vnd.observable.javascript">
    selectedCountriesForAnalysis = {
      if (analysisMode === "single") {
        return [selectedCountry];
      } else if (analysisMode === "multi") {
        return selectedCountries;
      } else {
        return africaCountries.map(c => c.name);
      }
    }
  </script>
  <script id="155" type="application/vnd.observable.javascript">
    countryColorScaleDeep = d3.scaleOrdinal()
      .domain(africaCountries.map(c => c.name))
      .range([
        "#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00",
        "#a65628", "#f781bf", "#999999", "#66c2a5", "#fc8d62",
        "#8da0cb", "#e78ac3", "#a6d854", "#ffd92f", "#e5c494",
        "#b3b3b3", "#1b9e77", "#d95f02", "#7570b3", "#e7298a",
        "#66a61e", "#e6ab02", "#a6761d", "#666666", "#7fc97f",
        "#beaed4", "#fdc086", "#ffff99", "#386cb0", "#f0027f",
        "#bf5b17", "#666666", "#1a9850", "#fdae61", "#abd9e9",
        "#2c7bb6", "#d7191c", "#fdae61", "#abd9e9", "#2c7bb6",
        "#d01c8b", "#f1b6da", "#b8e186", "#4d9221", "#c51b7d",
        "#de77ae", "#f1b6da", "#fde0ef", "#e6f5d0", "#7fbc41"
      ])


  </script>
  <script id="167" type="application/vnd.observable.javascript">

    // Map boundries
    async function loadBoundaries(level = 'adm0') {
      const boundariesUrl = `https://raw.githubusercontent.com/AdaptationAtlas/boundaries/main/${level}_simplified.geojson`;
      return d3.json(boundariesUrl);
    }


  </script>
  <script id="169" type="application/vnd.observable.javascript">
    // WorldPop
    async function loadPopulationData() {
      // WorldPop API endpoint
      const url = "https://www.worldpop.org/rest/data/pop/wpgp?iso3=";
      // or Google Earth Engine
      return await fetch(url).then(d => d.json());
    }


  </script>
  <script id="171" type="application/vnd.observable.javascript">
    // Climate dataÔºàCHC-CMIP6Ôºâ
    async function loadClimateProjections(scenario = 'ssp245') {
      const baseUrl = "https://data.chc.ucsb.edu/products/CHC-CMIP6/";
      return d3.csv(`${baseUrl}/africa_${scenario}_precipitation.csv`);
    }
  </script>
  <script id="223" type="application/vnd.observable.javascript">
    // WHO Global Health Observatory API
    whoAPI = "https://ghoapi.azureedge.net/api"
  </script>
  <script id="225" type="application/vnd.observable.javascript">
    // World Bank API
    worldBankAPI = "https://api.worldbank.org/v2"
  </script>
  <script id="227" type="application/vnd.observable.javascript">
    // GBIF API
    gbifAPI = "https://api.gbif.org/v1"
  </script>
  <script id="186" type="application/vnd.observable.javascript">
    malariaAtlasAPI = "https://malariaatlas.org/api/v1"
  </script>
  <script id="190" type="application/vnd.observable.javascript">
    corsProxy = "https://corsproxy.io/?"
  </script>
  <script id="193" type="application/vnd.observable.javascript">
    // malaria data
    malariaData = d3.json(
      `${worldBankAPI}/country/all/indicator/SH.MLR.INCD.P3?format=json&date=2020:2023&per_page=500`
    ).then(data => {
      const processed = {};
      if (data && data[1]) {
        data[1].forEach(entry => {
          if (entry.country && entry.value) {
            processed[entry.country.value] = {
              incidence: entry.value,
              year: entry.date,
              iso3: entry.country.id
            };
          }
        });
      }
      return processed;
    })
  </script>
  <script id="233" type="application/vnd.observable.javascript">
    // health system volume data
    healthSystemData = d3.json(
      `${worldBankAPI}/country/all/indicator/SH.MED.PHYS.ZS;SH.MED.BEDS.ZS;SH.ACS.MONY.Q1.ZS?format=json&date=2020:2023&per_page=1000`
    ).then(data => {
      const processed = {};
      if (data && data[1]) {
        data[1].forEach(entry => {
          const country = entry.country.value;
          if (!processed[country]) processed[country] = {};

          if (entry.indicator.id === "SH.MED.PHYS.ZS") {
            processed[country].physicians = entry.value;
          } else if (entry.indicator.id === "SH.MED.BEDS.ZS") {
            processed[country].beds = entry.value;
          } else if (entry.indicator.id === "SH.ACS.MONY.Q1.ZS") {
            processed[country].access = entry.value;
          }
        });
      }
      return processed;
    })
  </script>
  <script id="231" type="application/vnd.observable.javascript">
    // population data
    populationData = d3.json(
      `${worldBankAPI}/country/all/indicator/SP.POP.TOTL;SP.RUR.TOTL.ZS;SP.URB.TOTL.ZS?format=json&date=2023&per_page=1000`
    ).then(data => {
      const processed = {};
      if (data && data[1]) {
        data[1].forEach(entry => {
          const country = entry.country.value;
          if (!processed[country]) processed[country] = {};

          if (entry.indicator.id === "SP.POP.TOTL") {
            processed[country].total = entry.value;
          } else if (entry.indicator.id === "SP.RUR.TOTL.ZS") {
            processed[country].ruralPct = entry.value;
          } else if (entry.indicator.id === "SP.URB.TOTL.ZS") {
            processed[country].urbanPct = entry.value;
          }
        });
      }
      return processed;
    })
  </script>
  <script id="242" type="application/vnd.observable.javascript">
    // ËºâÂÖ•ÁòßÁñæÁôºÁîüÁéáÊï∏ÊìöÔºà‰ΩøÁî®WHOÊàñMalaria AtlasÊï∏ÊìöÔºâ
    malariaIncidenceData = {
      try {
        // option1 1: 
        // const data = await FileAttachment("malaria_incidence_2023.csv").csv();

        // option 2: GHDx API
        const response = await fetch(
          `${corsProxy}https://ghdx.healthdata.org/api/v1/locations/africa/malaria`
        ).catch(() => null);

        if (!response || !response.ok) {
          // backup: world bank APIÔºàCORSÔºâ
          const wbData = await d3.json(
            "https://api.worldbank.org/v2/country/all/indicator/SH.MLR.INCD.P3?format=json&date=2020:2023&per_page=500"
          );

          // convert format
          const processedData = {};
          if (wbData && wbData[1]) {
            wbData[1].forEach(entry => {
              if (entry.country && entry.value) {
                processedData[entry.country.value] = {
                  incidence: entry.value,
                  year: entry.date,
                  iso3: entry.country.id
                };
              }
            });
          }
          return processedData;
        }

        return await response.json();
      } catch (error) {
        console.error("Error loading malaria data:", error);

        return {};
      }
    }
  </script>
  <script id="374" type="application/vnd.observable.javascript">

    diseaseExpansionAnalysis = {
      const incidence = await malariaIncidenceData;
      const suitability = await climateSuitabilityData;
      const vectors = await vectorDistributionData;

      return selectedCountriesForAnalysis.map(countryName => {
        const countryData = africaCountries.find(c => c.name === countryName);
        const incidenceVal = incidence[countryName]?.incidence || 0;
        const suit = suitability[countryName] || {};
        const vector = vectors[countryName] || {};

        // cal expand risk
        const currentRisk = suit.currentSuitability || 0.5;
        const futureRisk = climateScenario === "RCP8.5 (Pessimistic)" ? 
                           suit.futureSuitability_ssp585 || 0.7 :
                           suit.futureSuitability_ssp245 || 0.6;

        return {
          country: countryName,
          lat: countryData?.lat || 0,
          lon: countryData?.lon || 0,
          currentIncidence: incidenceVal,
          currentSuitability: currentRisk * 100,
          futureSuitability: futureRisk * 100,
          expansionRisk: ((futureRisk - currentRisk) / currentRisk * 100).toFixed(1),
          vectorSpecies: vector.speciesCount || 0,
          vectorOccurrences: vector.occurrences || 0,
          trend: futureRisk > currentRisk ? "expanding" : "stable"
        };
      });
    }

  </script>
  <script id="197" type="application/vnd.observable.javascript">
    climateSuitabilityData = {
      // CHC (Climate Hazards Center) open data
      const baseUrl = "https://data.chc.ucsb.edu/products/CHPclim/netcdf/";

      try {
        // rain & temp data
        const data = await d3.csv(
          "https://raw.githubusercontent.com/AdaptationAtlas/data/main/climate_suitability_malaria.csv"
        );

        return data.reduce((acc, row) => {
          acc[row.country] = {
            currentSuitability: parseFloat(row.current_suitability),
            futureSuitability_ssp245: parseFloat(row.future_ssp245),
            futureSuitability_ssp585: parseFloat(row.future_ssp585),
            changePct: parseFloat(row.change_pct)
          };
          return acc;
        }, {});
      } catch (error) {
        console.error("Error loading climate suitability:", error);
        return {};
      }
    }
  </script>
  <script id="384" type="application/vnd.observable.javascript">

    compoundRiskHotspots = {
      const climate = await climateSuitabilityData;
      const health = await healthSystemCapacityData;
      const vectors = await vectorDistributionData;

      return selectedCountriesForAnalysis.map(country => {
        const climateRisk = climate[country]?.changePct || 0;
        const healthCap = health[country] || {};
        const vectorRisk = vectors[country]?.occurrences || 0;

        // Ë®àÁÆóË§áÂêàÈ¢®Èö™ÂàÜÊï∏
        const climateScore = Math.min(100, Math.abs(climateRisk) * 2);
        const healthScore = 100 - (healthCap.UHC_INDEX || 50); // high if it's a weak system
        const vectorScore = Math.min(100, vectorRisk / 10);

        const compoundRisk = (climateScore * 0.4 + healthScore * 0.4 + vectorScore * 0.2);

        return {
          country: country,
          climateRisk: climateScore.toFixed(0),
          healthVulnerability: healthScore.toFixed(0),
          vectorPressure: vectorScore.toFixed(0),
          compoundRisk: compoundRisk.toFixed(0),
          riskLevel: compoundRisk > 70 ? "Critical" :
                     compoundRisk > 50 ? "High" :
                     compoundRisk > 30 ? "Medium" : "Low",
          priorityRank: 0 
        };
      }).sort((a, b) => b.compoundRisk - a.compoundRisk)
        .map((d, i) => ({...d, priorityRank: i + 1}));
    }
  </script>
  <script id="377" type="application/vnd.observable.javascript">

    newlyExposedPopulation = {
      const population = await populationExposureData;
      const expansion = await diseaseExpansionAnalysis;

      return expansion.map(country => {
        const pop = population[country.country] || {};
        const expansionArea = country.expansionRisk > 0 ? country.expansionRisk / 100 : 0;

        const totalPop = pop.totalPopulation || 1000000;
        const newlyExposed = totalPop * expansionArea * 0.3; 

        return {
          country: country.country,
          totalPopulation: totalPop,
          newlyExposed: Math.round(newlyExposed),
          ruralExposed: Math.round(newlyExposed * 0.7),
          urbanExposed: Math.round(newlyExposed * 0.3),
          childrenExposed: Math.round(newlyExposed * 0.42),
          riskCategory: newlyExposed > 1000000 ? "Very High" :
                        newlyExposed > 500000 ? "High" :
                        newlyExposed > 100000 ? "Medium" : "Low"
        };
      });
    }


  </script>
  <script id="200" type="application/vnd.observable.javascript">
    populationExposureData = {
      try {
        // WorldPop REST API
        const response = await fetch(
          `${corsProxy}https://www.worldpop.org/rest/data/pop/wpgp?iso3=KEN,UGA,TZA,RWA,ETH,NGA,GHA,ZAF`
        );

        if (!response.ok) {
          // backup: world bank population
          const wbPop = await d3.json(
            "https://api.worldbank.org/v2/country/KE;UG;TZ;RW;ET;NG;GH;ZA/indicator/SP.POP.TOTL?format=json&date=2023"
          );

          const popData = {};
          if (wbPop && wbPop[1]) {
            wbPop[1].forEach(entry => {
              const country = africaCountries.find(c => c.cca2 === entry.country.id);
              if (country) {
                popData[country.name] = {
                  totalPopulation: entry.value,
                  ruralPopulation: entry.value * 0.65, // ‰º∞Ë®àÂÄº
                  urbanPopulation: entry.value * 0.35
                };
              }
            });
          }
          return popData;
        }

        return await response.json();
      } catch (error) {
        console.error("Error loading population data:", error);
        return {};
      }
    }
  </script>
  <script id="203" type="application/vnd.observable.javascript">
    // GBIF
    vectorDistributionData = {
      try {
        // GBIF API - nopheles
        const gbifData = await d3.json(
          "https://api.gbif.org/v1/occurrence/search?taxonKey=1901&continent=AFRICA&limit=300"
        );


        const vectorByCountry = {};
        if (gbifData && gbifData.results) {
          gbifData.results.forEach(occurrence => {
            const country = occurrence.country;
            if (country) {
              if (!vectorByCountry[country]) {
                vectorByCountry[country] = {
                  occurrences: 0,
                  species: new Set(),
                  locations: []
                };
              }
              vectorByCountry[country].occurrences++;
              if (occurrence.species) {
                vectorByCountry[country].species.add(occurrence.species);
              }
              if (occurrence.decimalLatitude && occurrence.decimalLongitude) {
                vectorByCountry[country].locations.push({
                  lat: occurrence.decimalLatitude,
                  lng: occurrence.decimalLongitude
                });
              }
            }
          });
        }


        Object.keys(vectorByCountry).forEach(country => {
          vectorByCountry[country].speciesCount = vectorByCountry[country].species.size;
        });

        return vectorByCountry;
      } catch (error) {
        console.error("Error loading GBIF data:", error);
        return {};
      }
    }
  </script>
  <script id="184" type="application/vnd.observable.javascript">
    healthSystemCapacityData = {
      try {
        // WHO GHO API
        const indicators = [
          "HWF_0001", // the density of doctor access
          "DEVICES_AVAILABILITY", // the availability of equipment
          "UHC_INDEX_REPORTED" // public health rate
        ];

        const requests = indicators.map(ind => 
          d3.json(`https://ghoapi.azureedge.net/api/${ind}?$filter=SpatialDim eq 'AFR'`)
        );

        const results = await Promise.all(requests);

        const healthData = {};
        results.forEach(result => {
          if (result && result.value) {
            result.value.forEach(entry => {
              const country = entry.SpatialDim;
              if (!healthData[country]) healthData[country] = {};
              healthData[country][entry.Dim1] = entry.NumericValue;
            });
          }
        });

        return healthData;
      } catch (error) {
        console.error("Error loading health system data:", error);
        // back up: world bank health data
        const wbHealth = await d3.json(
          "https://api.worldbank.org/v2/country/all/indicator/SH.MED.PHYS.ZS;SH.MED.BEDS.ZS?format=json&date=2020:2023&per_page=1000"
        );
        return wbHealth;
      }
    }


  </script>
</notebook>
